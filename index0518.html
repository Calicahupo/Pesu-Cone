<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-25071088-1"></script>
<script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());  gtag('config', 'UA-25071088-1'); </script>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0" http-equiv="Content-Type"/>
<title>Floresta v518</title>
<style>svg text { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;}
	svg text::selection { background: none;}
	svg {display:block}
	#sBdiv{position:fixed; top:0px; right:0px; height:100%; width:66px;}
	#bBdiv{position:fixed; bottom:0px; left:0px;}
@font-face { font-family: 'Steelfish'; src: url('diodi/SteelfishRg-Regular.eot'); src: local('SteelfishRg-Regular'),
 	url('diodi/SteelfishRg-Regular.eot?#iefix') format('embedded-opentype'),
 	url('diodi/SteelfishRg-Regular.woff2') format('woff2'), url('diodi/SteelfishRg-Regular.woff') format('woff'),
 	url('diodi/SteelfishRg-Regular.ttf') format('truetype'),
 	url('diodi/SteelfishRg-Regular.svg#SteelfishRg-Regular') format('svg'); font-weight: normal; font-style: normal;}
@font-face { font-family: 'StrikeFighter'; src: url('diodi/StrikeFighter.eot');
 	src: local('Strike Fighter'), local('diodi/StrikeFighter'),
 	url('diodi/StrikeFighter.eot?#iefix') format('embedded-opentype'), url('diodi/StrikeFighter.woff2') format('woff2'),
 	url('diodi/StrikeFighter.woff') format('woff'), url('diodi/StrikeFighter.ttf') format('truetype'),
 	url('diodi/StrikeFighter.svg#StrikeFighter') format('svg'); font-weight: normal; font-style: normal;}
@font-face { font-family: 'profont'; src: url('diodi/ProFontWindows.eot'); src: local('ProFontWindows'),
 	url('diodi/ProFontWindows.eot?#iefix') format('embedded-opentype'),url('diodi/ProFontWindows.woff2') format('woff2'),
 	url('diodi/ProFontWindows.woff') format('woff'), url('diodi/ProFontWindows.ttf') format('truetype'),
 	url('diodi/ProFontWindows.svg#ProFontWindows') format('svg'); font-weight: normal; font-style: normal;}

	html{height:100%;padding:0px;margin:0px;font-family:profont;font-size:13px;background-color:black;color:white;}
	body{height:100%;padding:0px;margin:0px;background-color:transparent;}
</style>
<script src="diodi/aldiode-data.js"></script>
<script src="diodi/lodash.js"></script>
<script>
var AL={ 
	fe: 	"type",
	fes: 	["type","mood","mosaic"],
	tools: 	["play","fastForward","next","forward"],
	tunes: 	["100","100","100","100"],
	play: false, 	fastForward:false, 	moved: false}
var sV =document.createElementNS( "http://www.w3.org/2000/svg","svg");
var sV1 =document.createElementNS( "http://www.w3.org/2000/svg","svg");
var sV2 =document.createElementNS( "http://www.w3.org/2000/svg","svg");
var nS =sV.namespaceURI;
var nS1 =sV1.namespaceURI;
var nS2 =sV2.namespaceURI;
var ui ={winWid:0, winHei:0,
	sB:{disWid:66, disHei:0, disHrz:0, disVrt:0, rowHei:39,fesHei:0, btnBrd:4, bTOX:6, 	bTOY:10, fnt:15, HUDhei:25,
		btnTxt:"#cccccc",btnU:"#444444",	btnR:"#111111",		btnD:"#080808",		btnL:"#333333", 	sel:"#1c1c1c",
		selTxt:"#ffffff",selU:"#000000",	selR:"#333333",		selD:"#555555",		selL:"#080808", 	btn:"#333333",
		bG:"#222222", HUDbg:"#444444"},
	tB:{disHei: 0,/*40*/ disVrt:0, bG:"#000000"},
	bB:{disHei: 25},
	tY:{disWid:0, disHei:0, disHrz:0, disVrt:0,
		cE:230, cuD:4, op2:0.7, c1x:0 ,c1y:0,/*40*/ c2x:0 ,c2y:0,/*40*/ cMarg:25, liY:0,
		base:"#234567", 	hilite:"#ff6600", area:"#345678", areaT:"#89abcd", selArea:"#6789ab",
		selAreaT:"#deefde", cShade:"#ffcccc", valNum:"#662525", shaNum:"#252566", plane:"#336688",
		selAreaB:"#6789ab", areaB:"#6789ab", shArea:"#012345", liB:"#666666", liI:"#444444", liT: "#cccccc",
		sLiB:"#cccccc", sLiI:"#888888", sLiT: "#ffffff", cIE:"#33d0aa"}, //ui.tY.cIE #95B388 #33d0aa
	sQ:{bG:"#000000", disHrz:0/*66*/, disWid:0},
	mO:{base:"#002200", key:"#003300", key2:"#004400", selKey:"#005500", selTxt:"#00ee00", dis:"#221900", disStr: "#110800", stroke:"#009900", stroke2:"#008800", hilTxt: "#00cc00", selKey2:"#007700", selKey3: "#004400", stroke3: "#002200"},
	mC:{liW:140},
	red: {l: { h:0  , s:25 , v:100}, f:{ h:0  , s:50 , v:50 }, h:{ h:0  , s:100, v:100}},
	cya: {l: { h:180, s:25 , v:100}, f:{ h:180, s:50 , v:50 }, h:{ h:180, s:100, v:100}},
	gre: {l: { h:135, s:25 , v:100}, f:{ h:135, s:50 , v:50 }, h:{ h:135, s:100, v:100}}, 
	lil: {l: { h:315, s:25 , v:100}, f:{ h:315, s:50 , v:50 }, h:{ h:315, s:100, v:100}}, 
	yel: {l: { h:60 , s:25 , v:100}, f:{ h:60 , s:50 , v:50 }, h:{ h:60 , s:100, v:100}}, 
	vio: {l: { h:275, s:25 , v:100}, f:{ h:275, s:50 , v:50 }, h:{ h:275, s:100, v:100}}, 
	blu: {l: { h:222, s:25 , v:100}, f:{ h:222, s:50 , v:50 }, h:{ h:222, s:100, v:100}}, 
	ora: {l: { h:30 , s:25 , v:100}, f:{ h:30 , s:50 , v:50 }, h:{ h:30 , s:100, v:100}}, 
	gra: {l: { h:1  , s:1  , v:100}, f:{ h:1  , s:1  , v:50 }, h:{ h:1  , s:1  , v:1}}}
var EN ={ sims:[], simsL:0 };
var OM ={ AL:AL, ui:ui};
function predraw(){ ui.winWid =window.innerWidth; ui.winHei =window.innerHeight;
	AL.fesLen =AL.fes.length; AL.toolsLen =AL.tools.length;
	ui.sB.disHei =ui.winHei-ui.tB.disHei; 	ui.sB.disHrz =ui.winWid-ui.sB.disWid; ui.sB.fesHei =AL.fesLen * ui.sB.rowHei;
	ui.sB.disVrt =ui.tB.disHei;

	ui.tB.disWid=ui.winWid-ui.sB.disWid; ui.disHrz=ui.sB.disWid;

	ui.bB.disHei=ui.winHei/12;
	ui.bB.disWid=ui.winWid-ui.sB.disWid;
	ui.bB.disHrz=0;
	ui.bB.disVrt=ui.winHei-ui.winHei/12;

	ui.tY.disWid =ui.winWid-ui.sB.disWid; ui.tY.disHei = ui.winHei; ui.tY.cE=Math.min(ui.winWid,ui.winHei)/3;
	ui.tY.cuHrz =ui.winWid-ui.sB.disWid-(2*(ui.tY.cE/ui.tY.cuD))-ui.tY.cE-ui.tY.cMarg;
	ui.tY.c2x= -(1.5 * ui.tY.cE)-ui.tY.cMarg;
	ui.tY.liW= ui.winWid-(1*ui.sB.disWid)-(4*(ui.tY.cE/ui.tY.cuD))-(2*ui.tY.cE)-(3*ui.tY.cMarg); ui.tY.liX=ui.sQ.disWid;
	ui.tY.liX2=ui.sQ.disWid; ui.tY.liHe=ui.winHei-ui.tB.disHei; ui.tY.liY=ui.tB.disHei;
	ui.tY.keX=ui.sB.disWid+ui.tY.liW+ui.tY.cMarg; ui.tY.keW=(4*(ui.tY.cE/ui.tY.cuD))+(2*ui.tY.cE)+ui.tY.cMarg;
	ui.tY.keY=(2*(ui.tY.cE/ui.tY.cuD))+ui.tY.cE+(2*ui.tY.cMarg)+ui.tY.c1y;
	ui.tY.keyGap= ui.tY.cMarg -(ui.tY.cMarg/1.618);
	ui.tY.keyWid= (ui.tY.keW-(15*ui.tY.keyGap))/16;
	ui.tY.stY=ui.tY.keY+((3*ui.tY.cE)/5);

	ui.mO.plW=Math.min(ui.winWid,ui.winHei)/1.5; 	ui.mO.plX =ui.winWid-ui.sB.disWid-ui.tY.cMarg-ui.mO.plW;
	ui.mO.plH=Math.min(ui.winWid,ui.winHei)/2; 		ui.mO.plY =ui.tB.disHei+ui.tY.cMarg;
	ui.mO.kex=ui.sQ.disWid+ui.tY.liW+ui.tY.cMarg; 	ui.mO.keX =ui.winWid-ui.sB.disWid-ui.tY.cMarg;
	ui.mO.KeW=ui.mO.keX-ui.mO.kex; 					ui.mO.keW =(ui.mO.KeW-(11*ui.tY.keyGap))/12;
	ui.mO.disWid=ui.mO.KeW-ui.mO.plW-ui.tY.cMarg;
	ui.mO.disHei = ui.mO.plY+((6*ui.tY.cMarg))+(2*ui.tY.cMarg*1.618) + 1.618*(2*ui.tY.cMarg);
	ui.mO.taH = ui.mO.plH-ui.tY.keyWid-ui.tY.cMarg;
	ui.mO.tRH = Math.round(ui.mO.taH*(3/11));
	ui.mO.tRL = Math.round(ui.mO.taH*(2/11));
	ui.mO.fRH = Math.round(ui.mO.tRH/1.618);
	ui.mO.fRH2= Math.round(ui.mO.tRH/1.618/1.3);
	ui.mO.fRL = Math.round(ui.mO.tRL/1.618);
	ui.mO.fRL2= Math.round(ui.mO.tRL/1.618/1.3);
	//ui.mO.tRL = Math.round(ui.mO.taH*(1.618/11));

	ui.mC.disWid=ui.winWid-ui.sB.disWid-ui.sQ.disWid-ui.mC.liW;

	sV.setAttribute( 'height', ui.winHei); sV.setAttribute( 'width', ui.winWid-ui.sB.disWid);
	sV1.setAttribute( 'height', ui.winHei); sV1.setAttribute( 'width', ui.sB.disWid);
	sV2.setAttribute( 'height', ui.bB.disHei); sV2.setAttribute( 'width', ui.bB.disWid);
}

var defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
var filter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
filter.setAttribute("id","f1");	filter.setAttribute("x","-40%");
filter.setAttribute("y","0"); filter.setAttribute("width","180%");
var gaussianFilter = document.createElementNS("http://www.w3.org/2000/svg", "feGaussianBlur");
gaussianFilter.setAttribute("in","SourceGraphic");	gaussianFilter.setAttribute("stdDeviation","6");
filter.appendChild(gaussianFilter);	defs.appendChild(filter); sV.appendChild(defs);


function mkL(x,y,w,h,id,co,cl,sC,sW,pE,rx,ry){ var r=document.createElementNS( nS,'rect');
					if( x> -1){ 	r.setAttribute( 'x',x)}	
					if( y> -1){ 	r.setAttribute( 'y',y)}
					if(rx){ 		r.setAttribute( 'rx',rx)}
					if(ry){ 		r.setAttribute( 'ry',ry)}
					if(sC!=""){ 	/*w -=sW*2; h -=sW*2;*/ r.setAttribute( 'stroke',sC); r.setAttribute( 'stroke-width',sW)}
									r.setAttribute( 'width',w);
									r.setAttribute( 'height',h);
					if( id!=false){ r.setAttribute( 'id', 	id) }
					if( co!=false){ r.setAttribute( 'fill', co) }
					if( cl!=false){ r.setAttribute( 'class',cl) }
					if( pE==false){ r.setAttribute( 'pointer-events', 'none');}return r}
function mkT(x,y,id,co,cl,fonSiz,txt,fonFam,anc,op){ var t =document.createElementNS( nS,'text'); y+=fonSiz;
					if( x> -1){ 	t.setAttribute( 'x',x)}	
					if( y> -1){ 	t.setAttribute( 'y',y)}
			if(fonSiz!=false){ 		t.setAttribute( 'font-size',fonSiz)}
				if( id!=false){ 	t.setAttribute( 'id', 	id) }
				if( co!=false){ 	t.setAttribute( 'fill', co) }
				if( cl!=false){ 	t.setAttribute( 'class',cl) }
					if( fonFam){ 	t.setAttribute( 'font-family',fonFam) }
									t.setAttribute( 'pointer-events', 'none');
				if(anc) 	{ 		t.setAttribute( 'text-anchor',anc)}
				if(op) 		{	 	t.setAttribute( 'opacity',op)}
									t.textContent =txt; return t}
function mkS(pt,id,co,cl,op) { var p=document.createElementNS( nS,'polygon'); p.setAttribute("points", pt);
	p.setAttribute( 'fill',co); if(id!=false){p.setAttribute( 'id',id)} p.setAttribute( 'class',cl); if(op!=false){ p.setAttribute( 'opacity',op)} p.setAttribute( 'pointer-events', 'none');return p}



function mkFb( n,sB,ni){ var id="sB_btn-"+n; n = n * sB.rowHei;
	if( AL.fe != ni){ var e =mkL( 0, n+ui.sB.disVrt, sB.disWid, sB.rowHei,	id, sB.btn,"sB_btn","")}
	else 					{var e =mkL( 0, n+ui.sB.disVrt, sB.disWid, sB.rowHei,	id, sB.sel,"sB_btn","")} return e }
function mkFt( n,sB,ni){ var id="sB_btT-"+n; n = n * sB.rowHei;
	if( AL.fe != ni){ var e =mkT( 0+sB.bTOX, n+sB.bTOY+ui.sB.disVrt,	id, sB.btnTxt, "sB_btT",15,ni,'profont')}
	else 					{var e =mkT( 0+sB.bTOX, n+sB.bTOY+ui.sB.disVrt,	id, sB.selTxt, "sB_btT",15,ni,'profont')}return e }
function mkFr( n,sB,ni){ var et=[]; var yi=(n * sB.rowHei)+sB.disVrt; if( AL.fe != ni) 
		{var e=mkL( 0, yi,sB.disWid, sB.btnBrd, "sB_btnBrd-"+n, sB.btnU, "sB_btnBrd", "",false,false); et.push( e);
		e=mkL(0, yi+sB.rowHei-sB.btnBrd,sB.disWid, sB.btnBrd, "sB_btnBrd-"+n, sB.btnD, "sB_btnBrd", "",false,false);
		et.push( e); var v = 0+","+yi+" "+ 				(0+sB.btnBrd)+","+(yi+sB.btnBrd)+" "+
			(0+sB.btnBrd)+","+(yi+sB.rowHei-sB.btnBrd)+" "+0+","+(yi+sB.rowHei);
		e=mkS( v,"sB_btnBrd-"+n,sB.btnL/*"#880000"*/,"sB_btnBrd",false); et.push( e);
		var v = 0+sB.disWid+","+yi+" "+ 	(0+sB.disWid-sB.btnBrd)+","+(yi+sB.btnBrd)+" "+
			(0+sB.disWid-sB.btnBrd)+","+(yi+sB.rowHei-sB.btnBrd)+" "+(0+sB.disWid)+","+(yi+sB.rowHei);
		e=mkS( v,"sB_btnBrd-"+n,sB.btnR/*"#880000"*/,"sB_btnBrd",false); et.push( e)}
	else{ var e=mkL( 0, yi,sB.disWid, sB.btnBrd, "sB_btnBrd-"+n, sB.selU, "sB_btnBrd", "",false,false); et.push( e);
		e=mkL( 0, yi+sB.rowHei-sB.btnBrd,sB.disWid,sB.btnBrd, "sB_btnBrd-"+n, sB.selD, "sB_btnBrd", "",false,false);
		et.push( e); var v = 0+","+yi+" "+ 				(0+sB.btnBrd)+","+(yi+sB.btnBrd)+" "+
			(0+sB.btnBrd)+","+(yi+sB.rowHei-sB.btnBrd)+" "+0+","+(yi+sB.rowHei);
		e=mkS( v,"sB_btnBrd-"+n,sB.selL/*"#880000"*/,"sB_btnBrd",false); et.push( e);
		var v = 0+sB.disWid+","+yi+" "+ 	(0+sB.disWid-sB.btnBrd)+","+(yi+sB.btnBrd)+" "+
			(0+sB.disWid-sB.btnBrd)+","+(yi+sB.rowHei-sB.btnBrd)+" "+(0+sB.disWid)+","+(yi+sB.rowHei);
		e=mkS( v,"sB_btnBrd-"+n,sB.selR/*"#880000"*/,"sB_btnBrd",false); et.push( e)} return et}
function mkI(x,y,X,Y,id,co,st,op){var r=document.createElementNS( nS,'line');
	r.setAttribute( 'x1',x);r.setAttribute('x2',X);
	r.setAttribute('y1',y); r.setAttribute('y2',Y); r.setAttribute('id',id); r.setAttribute( 'opacity',op);
	r.setAttribute('stroke',co); r.setAttribute( 'stroke-width',st);return r}

function processTurn(sim){}
function refreshTool( t ) { var id="tool-"+t; var e=document.getElementById( id); e.remove();
							var id="toolT-"+t;var e=document.getElementById( id); e.remove();
	var T = mkTo( t,ui.sB); T.forEach( function(T){ sV1.appendChild( T)});}
function toolKey( e){ var t= parseInt(e.id.split("-").pop()); switch(AL.tools[t]){
	case "play" 		: AL.play = !AL.play; AL.fastForward=false;  		refreshTool(t);	break;
	case "fastForward" 	: AL.fastForward = !AL.fastForward; AL.play=false; 	refreshTool(t);	break;
	case "next" 		: processSubTurn(AL.sim);  											break;
	case "forward" 		: processTurn(AL.sim);}}
function clearTool(n){var e=Array.from(document.querySelectorAll('sB')); e.forEach( function(e){ e.remove()})}
function mkTo( n, sB){ var r=[]; var b; var l; var s; var y; var x=sB.disWid-(sB.rowHei/2);
	b=mkL( sB.disWid-sB.rowHei, sB.fesHei+sB.HUDhei+(sB.rowHei*n)+1, sB.rowHei-2, sB.rowHei-2, "tool-"+n,
		"#555555", "tool", "", 0, true, sB.rowHei/3.236); r.push(b);
	b=mkL( 2, sB.fesHei+sB.HUDhei+(sB.rowHei*n)+1, sB.disWid-sB.rowHei-4, sB.rowHei-2, "toolTune-"+n,
		"#555555", "tool", "", 0, true, sB.rowHei/3.236); r.push(b);
	b=mkI( 0,sB.fesHei+sB.HUDhei+(sB.rowHei*n)+(sB.rowHei/2), sB.disWid-sB.rowHei,
		sB.fesHei+sB.HUDhei+(sB.rowHei*n)+(sB.rowHei/2), "toolDeco"+n, sB.btnL, 3); r.push(b);
	b=mkT( (sB.disWid-sB.rowHei)/2, sB.fesHei+sB.HUDhei+(sB.rowHei*n),
		"toolMore-"+n, "#888", undefined,sB.rowHei/3.236, "▲","arial","middle"); r.push(b);
	b=mkT( (sB.disWid-sB.rowHei)/2, sB.fesHei+sB.HUDhei+(sB.rowHei*n)+(sB.rowHei/1.618),
		"toolLess-"+n, "#888", undefined,sB.rowHei/3.236, "▼","arial","middle"); r.push(b);
	b=mkT( (sB.disWid-sB.rowHei)/2, sB.fesHei+sB.HUDhei+(sB.rowHei*n)+(sB.rowHei/3.7),
		"toolDisp-"+n, "#fff", undefined,sB.rowHei/3, AL.tunes[n], "profont","middle"); r.push(b);
	switch( AL.tools[n]){ 	
		case "play" 		: AL.play 		? l="❚❚" : l="►"; 	s=sB.rowHei/1.618;
			y=sB.fesHei+sB.HUDhei+(sB.rowHei*n)+3;  						break;
		case "fastForward" 	: 	if(AL.fastForward){ l="❚❚"; s=sB.rowHei/1.618; y=sB.fesHei+sB.HUDhei+(sB.rowHei*n)+3}
								else{ l="►►"; s=sB.rowHei/3.236; y=sB.fesHei+sB.HUDhei+(sB.rowHei*n+3)+(sB.rowHei/5)}
								break;
		case "next" 		: l="❚►"; 							s=sB.rowHei/1.618;
			y=sB.fesHei+sB.HUDhei+(sB.rowHei*n)+3;  						break;
		case "forward" 		: l="❚►►"; 						 	s=sB.rowHei/3.236;
			y=sB.fesHei+sB.HUDhei+(sB.rowHei*n+3)+(sB.rowHei/5); }
	t=mkT( x, y, "toolT-"+n, "#ffffff", undefined, s, l, "arial", "middle");r.push(t);
	bindE( b, function(ev,e) { switch(ev){ case "mousedown" 	: toolKey( e);	break;}}); return r}
function mkHUD(sim){ var E=[]; var e=null;
	e=mkL(0,ui.sB.fesHei+3, ui.sB.disWid, ui.sB.HUDhei-6,"",ui.sB.HUDbg,""); E.push(e);
	e=mkT(ui.sB.disWid-3,ui.sB.fesHei+2, "", "#ffffff", "", ui.sB.fnt,AL.sim.in+":"+AL.sim.turn+AL.sim.personInTurn.ni.in, "profont","end"); E.push(e); return E}
function drawSidebar(){ var obs=[];  var buf =null;
	var div=document.getElementById("sBdiv");
	buf =mkL(0,ui.sB.disVrt,ui.sB.disWid,ui.sB.disHei,"sB",ui.sB.bG,"sB","");
	obs.push(buf);
	for( var i=0; i < AL.fesLen; i++){	buf =mkFb( i,ui.sB, AL.fes[i]); obs.push(buf);
										buf =mkFt( i,ui.sB, AL.fes[i]); obs.push(buf);
										buf =mkFr( i,ui.sB, AL.fes[i]); obs =obs.concat(buf)}
	buf=mkHUD( AL.sim); obs =obs.concat(buf);
	for( var n=0; n < AL.toolsLen;n++){ buf =mkTo( n, ui.sB);  			obs=obs.concat(buf)}
	obs.forEach( function(obs){ sV1.appendChild( obs)});
	div.appendChild(sV1); document.body.appendChild( div);
	bindMany( '.sB_btn', function(ev,e) { switch(ev){ case "mousedown" 	: sidebarKey( e);	break;}})}
function sidebarKey( e){ var tab= parseInt(e.id.split("-").pop()); AL.fe=AL.fes[tab]; clearScreen(); draw();}

function typeKey( e){ var tY= parseInt(e.id.split("-").pop()); tY=AL.Sociotypes.seed[tY]; tY=precalcSociotype(tY,OM.ab);
	if(AL.pE){AL.pE.ty=tY; AL.tY=tY;}
	else if( AL.tY==null){ AL.tY=tY;} else if(AL.tY!=tY){AL.tY=tY} else { AL.tY=null}
	clearScreen(); draw();}
function typeListKey( e){let r=e.id.split("-").pop(); r=OM.re.people.find(o => o.ni.in == r); 
	//console.log(r);
	console.log(OM.re.people);
	if(r.ty){ AL.tY = r.ty}
	if(r.mo){ AL.mO = r.mo}
	if(r.mo.bE){ AL.bE = r.mo.bE}
	if(r.mo.pM){ AL.pM = r.mo.pM}
	if(AL.pE==r){} else {AL.pE=r}; console.log(AL.pE); clearScreen(); draw();}
function clearScreen(){	var e=Array.from(document.querySelectorAll('rect, text, polygon, line, circle'));
 						e.forEach( function(e){ e.remove()})}
function draw(){ clearScreen(); drawSidebar(); 
	switch( AL.fe){ case "type": drawType(); break;
					case "mood": drawMood(); break;
					case "mosaic": drawMosaic(); break;}}
function bindE( e,c){
	e.addEventListener("mouseover", function(){ c("mouseover", e)});
	e.addEventListener("mousedown", function(){ c("mousedown", e)})}
function bindMany( sel,c){ var e=Array.from(document.querySelectorAll( sel));
	//e.forEach( function(e){ e.addEventListener("mouseover", function(){ c( "mouseover",	e)})});
	e.forEach( function(e){ e.addEventListener("mousedown", function(){ c( "mousedown", e)})})}
function bindMosaic( sel,c){ var e=Array.from(document.querySelectorAll( sel));
	e.forEach( function(e){ e.addEventListener("mouseover", function(){ 	c( "mouseover",	e)})});
	e.forEach( function(e){ e.addEventListener("mouseleave", function(){ 	c( "mouseleave",e)})});
	e.forEach( function(e){ e.addEventListener("mouseup", function(){ 		c( "mouseup",	e)})});
	e.forEach( function(e){ e.addEventListener("mousedown", function(){ 	c( "mousedown", e)})})}
function mkBottomBar(){ var E=[]; var e=null;
	var div=document.getElementById("bBdiv");
	var divW = ui.bB.disWid+"px";
	div.style.width = divW; 	div.style.height = ui.bB.disHei;
	//console.log(ui.bB.disWid);
	e=mkL(0,0,ui.bB.disWid,ui.bB.disHei,"bB","#000"); E.push(e);
	E.forEach( function(e){ sV2.appendChild( e)});
	div.appendChild(sV2); document.body.appendChild( div);
}
////function mkL(x,y,w,h,id,co,
function drawType(){ var buf =null;
	buf =mkL(ui.tY.disHrz,ui.tY.disVrt,ui.tY.disWid,ui.tY.disHei,"tY",ui.tY.base,"tY","");
	sV.appendChild(buf); document.body.appendChild( sV);
	mkTypeCube(ui.tY.c1x, ui.tY.c1y, "tYC1"); 	
	mkTypeCage(ui.tY.c2x, ui.tY.c2y, "tYC2"); 	
	mkTypeList();
	mkTopBar();								
	mkTypeKeys();
	mkTypeStage();								
	mkBottomBar(); }
function drS(v,l,id,cl,op){ var e=document.createElementNS( nS,'polygon'); e.setAttribute("points",v);
	e.setAttribute( 'fill',l); e.setAttribute('id',id); e.setAttribute('class',cl);
	if(op!=undefined){ e.setAttribute( 'opacity',op)} return e}
function drA(x,y,w,h,l,id,cl,b,L,op){ var e=document.createElementNS( nS,'rect'); e.setAttribute( 'fill',l);
	e.setAttribute('x',x);e.setAttribute('y',y); e.setAttribute( 'width',w); e.setAttribute( 'height',h); 
	if(b > 0){ e.setAttribute( 'stroke',L); e.setAttribute( 'stroke-width',b)}
	if(op!=undefined){ e.setAttribute( 'opacity',op)} e.setAttribute( 'id',id); e.setAttribute( 'class',cl); return e}
function drC(x,y,r,c,id,cl,sW,sC){ var e=document.createElementNS( nS,'circle'); e.setAttribute( 'fill',c);
	e.setAttribute('cx',x); e.setAttribute('cy',y); e.setAttribute('r',r); e.setAttribute('id',id);
	e.setAttribute('class',cl);	e.setAttribute('stroke',sC); e.setAttribute('stroke-width',sW); return e}

function mkTopBar(){ var E=[]; var e=null;
	e=mkL(ui.tB.disHrz, ui.tB.disVrt, ui.tB.disWid, ui.tB.disHei, "tB_bg", ui.tB.bG, "tB", ""); E.push(e);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}

function mkTypeCube(cX,cY,cl){ var e; var E=[]; var v=""; var w=ui.tY.cE; var h=ui.tY.cE; var id=cl; var d=ui.tY.cuD; var op=ui.tY.op2; var co=ui.tY.plane; var x=cX+h/d+ui.tY.cuHrz; var y=cY+h/d+ui.tY.cMarg;
	v =  x - (w/d)+","+(y+(h/2)+(h/d)) +" "+			(x + (w/d)+","+(y+(h/2)-(h/d)))+" "+
		(x+w+(w/d)+","+(y+(h/2)-(h/d)))+" "+			(x+w-(w/d)+","+(y+(h/2)+(h/d)));
	e =drS(v, ui.tY.cShade, id+"-cU-hrz", cl, op); 		E.push(e);
	v =  x - (w/d)+","+(y+(h/2)+(h/d)-(h/2)) +" "+		(x + (w/d)+","+(y+(h/2)-(h/d)-(h/2)))+" "+
		(x+w+(w/d)+","+(y+(h/2)-(h/d)-(h/2)))+" "+		(x+w-(w/d)+","+(y+(h/2)+(h/d)-(h/2)));
	e =drS(v, ui.tY.cShade, id+"-cU-top", cl, op);		E.push(e);
	v =  x - (w/d)+","+(y+(h/2)+(h/d)+(h/2)) +" "+		(x + (w/d)+","+(y+(h/2)-(h/d)+(h/2)))+" "+
		(x+w+(w/d)+","+(y+(h/2)-(h/d)+(h/2)))+" "+		(x+w-(w/d)+","+(y+(h/2)+(h/d)+(h/2)));
	e =drS(v, ui.tY.cShade, id+"-cU-btm", cl, op/1.618);E.push(e);
	v =  x + (w/2)-(w/d)+","+(y + (h/d)) +" "+			(x + (w/2)+(w/d)+","+(y - (h/d)))+" "+
		(x + (w/2)+(w/d)+","+(y+h-(h/d)))+" "+			(x + (w/2)-(w/d)+","+(y+h+(h/d)));		
	e =drS(v, ui.tY.cShade, id+"-cU-vrt", cl, op); 		E.push(e);
	e =drA(x+(w/d),	y-(h/d),w,h,co,id+"-btm",cl+"-btm pAIU",0,undefined,op); 		E.push(e);

	v = x+(w/4)+","+(y+(h/8)+(h/4)-(h/4))+" "+ 		(x+(w/8)+(w/4))+","+(y+(w/4)-(h/4))+" "+
		(x+(w/2))+","+(y+(h/8))+" "+ 				(x+(w/8)+(w/4))+","+(y+(w/2)-(h/4));
	e =drS(v, ui.tY.cIE, cl+"_IE-npp", cl); E.push(e);
	v = x+(w/4)+(w/2)+","+(y+(h/8)+(h/4)-(h/4))+" "+ 		(x+(w/8)+(w/4)+(w/2))+","+(y+(w/4)-(h/4))+" "+
		(x+(w/2)+(w/2))+","+(y+(h/8))+" "+ 				(x+(w/8)+(w/4)+(w/2))+","+(y+(w/2)-(h/4));
	e =drS(v, ui.tY.cIE, cl+"_IE-ppp", cl); E.push(e);
	v = x+(w/4)+(w/2)+","+(y+(h/8)+(h/4)-(h/4)+(h/2))+" "+ 		(x+(w/8)+(w/4)+(w/2))+","+(y+(w/4)-(h/4)+(h/2))+" "+
		(x+(w/2)+(w/2))+","+(y+(h/8)+(h/2))+" "+ 				(x+(w/8)+(w/4)+(w/2))+","+(y+(w/2)-(h/4)+(h/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-pnp", cl); E.push(e);
	v = x+(w/4)+","+(y+(h/8)+(h/4)-(h/4)+(h/2))+" "+ 		(x+(w/8)+(w/4))+","+(y+(w/4)-(h/4)+(h/2))+" "+
		(x+(w/2))+","+(y+(h/8)+(h/2))+" "+ 				(x+(w/8)+(w/4))+","+(y+(w/2)-(h/4)+(h/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-nnp", cl); E.push(e);

	e =drA(x, 		y, 		w,h,co,id+"-mid",cl+"-mid pAIU",0,undefined,op/1.618);	E.push(e);

	v = x+	","+(y+(h/8)+(h/4))+" "+ 			(x+(w/8))+","+(y+(w/4))+" "+
		(x+(w/4))+","+(y+(h/4)+(h/8))+" "+ 		(x+(w/8))+","+(y+(w/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-npn", cl); E.push(e);
	v = x+(w/2)+","+(y+(h/8)+(h/4))+" "+ 			(x+(w/8)+(w/2))+","+(y+(w/4))+" "+
		(x+(w/4)+(w/2))+","+(y+(h/4)+(h/8))+" "+ 	(x+(w/8)+(w/2))+","+(y+(w/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-ppn", cl); E.push(e);
	v = x+(w/2)+","+(y+(h/8)+(h/4)+(h/2))+" "+ 			(x+(w/8)+(w/2))+","+(y+(w/4)+(h/2))+" "+
		(x+(w/4)+(w/2))+","+(y+(h/4)+(h/8)+(h/2))+" "+ 	(x+(w/8)+(w/2))+","+(y+(w/2)+(h/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-pnn", cl); E.push(e);
	v = x+	","+(y+(h/8)+(h/4)+(h/2))+" "+ 			(x+(w/8))+","+(y+(w/4)+(h/2))+" "+
		(x+(w/4))+","+(y+(h/4)+(h/8)+(h/2))+" "+ 		(x+(w/8))+","+(y+(w/2)+(h/2));
	e =drS(v, ui.tY.cIE, cl+"_IE-nnn", cl); E.push(e);

	e =drA(x-(w/d),	y+(h/d),w,h,co,id+"-top",cl+"-top pAIU",0,undefined,op/1.618);		E.push(e);

e=mkT(x+(w/8),(y+(h/32)+(h/4)+(h/2)),cl+"_IET-nnn","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[0][0][0].ni,"profont","middle"); E.push(e);e=mkT(x+(w/8),(y+(h/8)+(h/4)+(h/2)),cl+"_IEN-nnn","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/8)+(w/2),(y+(h/32)+(h/4)+(h/2)),cl+"_IET-pnn","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[2][0][0].ni,"profont","middle");E.push(e);
	e=mkT(x+(w/8)+(w/2),(y+(h/8)+(h/4)+(h/2)),cl+"_IEN-pnn","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle");E.push(e);

e=mkT(x+(w/8)+(w/2),(y+(h/32)+(h/4)),cl+"_IET-ppn","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[2][2][0].ni,"profont","middle"); E.push(e);
	e=mkT(x+(w/8)+(w/2),(y+(h/8)+(h/4)),cl+"_IEN-ppn","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/8),(y+(h/32)+(h/4)),cl+"_IET-npn","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[0][2][0].ni,"profont","middle"); E.push(e);
	e=mkT(x+(w/8),(y+(h/8)+(h/4)),cl+"_IEN-npn","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/4)+(w/8),(y+(h/32)+(h/2)),cl+"_IET-nnp","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[0][0][2].ni,"profont","middle"); E.push(e);
	e=mkT(x+(w/4)+(w/8),(y+(h/2)+(h/8)),cl+"_IEN-nnp","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/4)+(w/8),(y+(h/32)),cl+"_IET-npp","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[0][2][2].ni,"profont","middle"); E.push(e);
	e=mkT(x+(w/4)+(w/8),(y+(h/8)),cl+"_IEN-nnp","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/4)+(w/8)+(w/2),(y+(h/32)),cl+"_IET-ppp","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[2][2][2].ni,"profont","middle"); E.push(e);
	e=mkT(x+(w/4)+(w/8)+(w/2),(y+(h/8)),cl+"_IEN-ppp","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle"); E.push(e);

e=mkT(x+(w/4)+(w/8)+(w/2),(y+(h/32)+(h/2)),cl+"_IET-pnp","#ffffff",cl+"_IET",w/11,OM.ab.absSpace[2][0][2].ni,"profont","middle");E.push(e);
	e=mkT(x+(w/4)+(w/8)+(w/2),(y+(h/2)+(h/8)),cl+"_IEN-pnp","#ffffff",cl+"_IEN",w/22,"0","tahoma","middle");E.push(e);
	//function mkT(x,y,id,co,cl,fonSiz,txt,fonFam,anc)
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}
	// green #95B300, yellow #DDB300, blue: #95B3D7
	// green #95B388, yellow #DDB300, blue: #95B3D7
	// function drC(x,y,r,c,id,cl,sW,sC)

function mkTypeCage(cX,cY,cl){

	function drAr(x,y,X,Y,lx,ly,lz,co,op){
		var cNi=AL.tY.relSpace[lx][ly][lz].ni;
		var E=[];var e=null;var id="_cUC-";var dx=false;var dy=false;var dz=false;var st;
		if(lx==2){ id+="p"} else if(lx==1){ id+="t"; dx=true;}else if(lx==0){ id+="n"}
		if(ly==2){ id+="p"} else if(ly==1){ id+="t"; dy=true;}else if(ly==0){ id+="n"}
		if(lz==2){ id+="p"} else if(lz==1){ id+="t"; dz=true;}else if(lz==0){ id+="n"}
		switch(AL.tY.relSpace[lx][ly][lz].str){ case 0: st=w/12; break; case 1: st=w/8; break; case 2:st=w/6; break;}
		if(dx){
			console.log(AL.tY.relSpace[lx][ly][lz].ni);
			if( AL.tY.relSpace[lx][ly][lz].aDi== 1){ x += w/4;
				v = (x-(w/6))+","+y+" "+x+","+(y+(w/12))+" "+x+","+(y-(w/12));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(x,y,w/13,"#484848","jou","jou",3,"#000000");  					F.push(e);
				e =mkT(x+1,y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(x,y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}
			else if( AL.tY.relSpace[lx][ly][lz].aDi== -1){ X -= w/4;
				v = (X+(w/6))+","+Y+" "+X+","+(Y+(w/12))+" "+X+","+(Y-(w/12));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(X,Y,w/13,"#484848","jou","jou",3,"#000000"); 					F.push(e);
				e =mkT(X+1,Y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(X,Y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}}
		if(dy){
			if( AL.tY.relSpace[lx][ly][lz].aDi== 1){ y += w/4;
				v = (x-(w/12))+","+y+" "+(x+(w/12))+","+y+" "+x+","+(y-(w/6));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(x,y,w/13,"#555533","jou","jou",3,"#000000"); 					F.push(e);
				e =mkT(x+1,y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(x,y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}
			else if( AL.tY.relSpace[lx][ly][lz].aDi== -1){ Y -= w/4;
				v = (X-(w/12))+","+Y+" "+(X+(w/12))+","+Y+" "+X+","+(Y+(w/6));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(X,Y,w/13,"#555533","jou","jou",3,"#000000"); 					F.push(e);
				e =mkT(X+1,Y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(X,Y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}}
		if(dz){
			if( AL.tY.relSpace[lx][ly][lz].aDi== -1){ x += w/6; y-= w/6;
				v = (x-(w/18))+","+(y-(w/18))+" "+(x-(w/9))+","+(y+(w/9))+" "+(x+(w/18))+","+(y+(w/18));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(x,y,w/13,"#336633","jou","jou",3,"#000000"); 					F.push(e);
				e =mkT(x+1,y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(x,y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}
			else if( AL.tY.relSpace[lx][ly][lz].aDi== 1){ Y += w/6; X -= w/6;
				v = (X+(w/18))+","+(Y+(w/18))+" "+(X+(w/9))+","+(Y-(w/9))+" "+(X-(w/18))+","+(Y-(w/18));
				e =drS(v, "#000000", id+"_head"); E.push(e);
				e =drC(X,Y,w/13,"#336633","jou","jou",3,"#000000"); 					F.push(e);
				e =mkT(X+1,Y-(w/11),"jou","#ffffff","jou",w/13,cNi,"profont","middle"); F.push(e);
				e =mkT(X,Y,"jou","#ffffff","jou",w/22,"0","tahoma", "middle"); 			F.push(e)}}
		e=mkI(x,y,X,Y,id,co,st); E.push(e); return E}

	function drFu(cx,cy,lx,ly,lz,o){
		var E=[]; var e=null; var col="#ff0000"; var st=1;
		var cl1="_cUF"; var id1=cl1+"-"; var cl2="_fuT"; var id2=cl2+"-"; var cl3="_fuN"; var id3=cl3+"-"; 
		if(o.str){ st=1}
		if(lx==2){ id1+="p"; id2+="p"; id3+="p"} else { id1+="n"; id2+="n"; id3+="n"}
		if(ly==2){ id1+="p"; id2+="p"; id3+="p"} else { id1+="n"; id2+="n"; id3+="n"}
		if(lz==2){ id1+="p"; id2+="p"; id3+="p"} else { id1+="n"; id2+="n"; id3+="n"}
		switch(o.ni){ 	case "f1" : case "f4" : col="#0000ff"; break;
						case "f6" : case "f7" : col="#000088"; break;
						case "f2" : case "f3" : col="#880000"; }
		e=drC(cx,cy,w/10,col,cl1,id1,st,"#000000"); E.push(e);
		e=mkT(cx+1,cy-(w/11),id2,"#ffffff",cl2,w/11,o.in,"profont","middle"); E.push(e);
		e=mkT(cx,cy,id3,"#ffffff",cl3,w/22,"0","tahoma","middle"); E.push(e); return E}

	var e; var E=[]; var F=[]; var v=""; var w=ui.tY.cE; var h=ui.tY.cE; var id=cl; var d=ui.tY.cuD; var op=ui.tY.op2; var co=ui.tY.plane; var x=cX+h/d+ui.tY.cuHrz; var y=cY+h/d+ui.tY.cMarg;

	e=drAr(x-(w/8),			y+(w/4)+(w/16),		x-(w/8),		y+w/8+h,			0,1,0,"#000000");E=E.concat(e);
	e=drAr(x-(w/4)-(w/16)+w,y+(w/4)+(w/16),		x-(w/4)-(w/16)+w,y+w/8+h,			2,1,0,"#000000");E=E.concat(e);
	e=drAr(x+(w/4)+w/16,	y-(w/8),			x+(w/4)+w/16,	y-(w/4)-(w/16)+h,	0,1,2,"#000000");E=E.concat(e);
	e=drAr(x+w+(w/8),		y-(w/8),			x+w+(w/8),		y-(w/4)-(w/16)+h,	2,1,2,"#000000");E=E.concat(e);

	e =drAr(x+(w/4)+w/16,	y-(w/8),			x+w+(w/8),		y-(w/8),			1,2,2,"#000000"); E=E.concat(e);
	e =drAr(x+(w/4)+w/16,	y-(w/4)-(w/16)+h,	x+w+(w/8),		y-(w/4)-(w/16)+h,	1,0,2,"#000000"); E=E.concat(e);
	e =drAr(x-(w/8),		y+(w/4)+(w/16),		x-(w/4)-(w/16)+w,y+(w/4)+(w/16),	1,2,0,"#000000"); E=E.concat(e);
	e =drAr(x-(w/8),		y+(w/8)+h,			x-(w/4)-(w/16)+w,y+(w/8)+h,			1,0,0,"#000000"); E=E.concat(e);

	e =drAr(x-(w/8),		y+(w/4)+(w/16), 	x+(w/4)+w/16,	y-(w/8), 			0,2,1,"#000000"); E=E.concat(e);
	e =drAr(x-(w/4)-(w/16)+w,y+(w/4)+(w/16),	x+w+(w/8),		y-(w/8), 			2,2,1,"#000000"); E=E.concat(e);
	e =drAr(x-(w/8),		y+(w/8)+h,			x+(w/4)+w/16,	y-(w/4)-(w/16)+h,	0,0,1,"#000000"); E=E.concat(e);
	e =drAr(x-(w/4)-(w/16)+w,y+(w/8)+h,			x+w+(w/8),		y-(w/4)-(w/16)+h,	2,0,1,"#000000"); E=E.concat(e);

	e =drFu(x-(w/8),		y+(w/4)+(w/16), 	0,2,0,AL.tY.relSpace[0][2][0]); E=E.concat(e);
	e =drFu(x-(w/8),		y+(w/8)+h,			0,0,0,AL.tY.relSpace[0][0][0]); E=E.concat(e);
	e =drFu(x-(w/4)-(w/16)+w,y+(w/4)+(w/16),	2,2,0,AL.tY.relSpace[2][2][0]); E=E.concat(e);
	e =drFu(x-(w/4)-(w/16)+w,y+(w/8)+h,			2,0,0,AL.tY.relSpace[2][0][0]); E=E.concat(e);
	e =drFu(x+(w/4)+w/16,	y-(w/8),			0,2,2,AL.tY.relSpace[0][2][2]); E=E.concat(e);
	e =drFu(x+w+(w/8),		y-(w/8),			2,2,2,AL.tY.relSpace[2][2][2]); E=E.concat(e);
	e =drFu(x+w+(w/8),		y-(w/4)-(w/16)+h,	2,0,2,AL.tY.relSpace[2][0][2]); E=E.concat(e);
	e =drFu(x+(w/4)+w/16,	y-(w/4)-(w/16)+h,	0,0,2,AL.tY.relSpace[0][0][2]); E=E.concat(e); E=E.concat(F);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}

function mkTypeList(compact){ var E=[]; var e=null; var liI=""; var liT=""; var liB=""; var width;
	var ctrHei=ui.winHei/18;
	var lisLen=18;
	var lisHei =ui.winHei-ui.bB.disHei-ctrHei;
	var lisY =ctrHei;
	var iteHei=lisHei/18;
	if(!compact){ width = ui.tY.liW} else{ width = ui.mC.liW}
	e =mkL(ui.tY.liX, ui.tY.liY+ui.tY.c1x, width, ui.tY.liHe,"tY_L",ui.sB.bG,"ty_L_bg",""); 	E.push(e);
	for(var n=0; n<OM.re.people.length;n++){
		if(OM.re.people[n] != AL.pE){ liI=ui.tY.liI; liT=ui.tY.liT; liB=ui.tY.liB;}
		else 						{ liI=ui.tY.sLiI;liT=ui.tY.sLiT;liB=ui.tY.sLiB;}
		e =mkL(ui.tY.liX2+1, iteHei*n+ctrHei+1,width-2,iteHei-2,"tY_Li-"+OM.re.people[n].ni.in,liI,"tY_Li",liB,1); E.push(e);
		e =mkT(ui.tY.liX2+4,(iteHei*n)-1+ctrHei,"tY_LiT-"+n,liT,"tY_LiT",20,OM.re.people[n].ni.in+" "+OM.re.people[n].ty.ni,"profont"); E.push(e);
		//console.log(OM.re.people[n]);
		if(OM.re.people[n].mo.symm){ liT2="#ffff00"} else{ liT2=liT}
		e =mkT(ui.tY.liX2+3*ui.tY.cMarg, (iteHei*n)-1+ctrHei,"tY_LiB-"+n,liT2,"tY_LiB",20,OM.re.people[n].mo.pM.niH+OM.re.people[n].mo.bE.nI+OM.re.people[n].mo.pM.niT,"times new roman"); E.push(e);
		if(!compact){e =mkT(ui.tY.liX2+140,(iteHei*n)-1+ctrHei+1,"tY_LiT-"+n,liT,"tY_LiT",20,OM.re.people[n].ni.name,"Steelfish"); E.push(e);}
	} E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);
	bindMany( '.tY_Li', function(ev,e) { switch(ev){ case "mousedown" 	: typeListKey( e);	break;}});}

function mkTypeKeys(){ var E=[]; var e=null; var area=""; var areaB=""; var areaT="";
	for(var n=0; n<16; n++){

		if((AL.tY==null)||(OM.ab.tYs[n].ni != AL.tY.ni)){ area=ui.tY.area; areaB=ui.tY.areaB; areaT=ui.tY.areaT; }
		else 							{ area=ui.tY.selArea; areaB=ui.tY.selAreaB; areaT=ui.tY.selAreaT; }
		e =mkL(ui.tY.keX+(n*(ui.tY.keyWid+ui.tY.keyGap))-ui.sB.disWid,ui.tY.keY,ui.tY.keyWid-1,ui.tY.keyWid-1,"tY_Keys-"+n,area,"tY_Keys",areaB,2);
		E.push(e);
		e=mkT(ui.tY.keX+(n*(ui.tY.keyWid+ui.tY.keyGap))+(ui.tY.keyWid/2)-1-ui.sB.disWid,ui.tY.keY+(ui.tY.keyWid/7)-1,
		"",areaT,"",ui.tY.keyWid/1.6,AL.Sociotypes.seed[n],"Steelfish","middle"); E.push(e);}
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);
	bindMany( '.tY_Keys', function(ev,e) { switch(ev){ case "mousedown" 	: typeKey( e);	break;}});}

//function mkT(x,y,id,co,cl,fonSiz,txt,fonFam,anc)
function mkTypeStage(){ 
if(AL.pE!=null){ var E=[]; var e=null; var x=ui.tY.cuHrz-(ui.tY.cMarg/2);//xxxx
	var e=mkT(ui.tY.keX-ui.sB.disWid, ui.tY.stY-ui.tY.cE/12, "-stg", "#ffffff", "stg", ui.tY.cE/6,AL.pE.ni.name, "profont","left");E.push(e);
	var e=mkT(x, ui.tY.stY-(ui.tY.cE/2), "-stg", "#ffffff", "stg", (2*ui.tY.cE)/5, AL.tY.zo, "StrikeFighter","middle");
	e.setAttribute("filter","url(#f1)"); E.push(e);
	var e=mkT(x, ui.tY.stY-(ui.tY.cE/2), "-stg", "#ffffff", "stg", (2*ui.tY.cE)/5, AL.tY.zo, "StrikeFighter","middle");
	e.setAttribute('opacity',0.62);E.push(e);
	var e=mkT(ui.winWid-ui.tY.cMarg-ui.sB.disWid, ui.tY.stY-ui.tY.cE/12, "", "#ffffff", "", ui.tY.cE/6, AL.pE.ty.ni, "profont","end"); E.push(e);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}}

function mkSequencer(){ var E=[]; var e=null;
	e= mkL(0,ui.tB.disHei,ui.sQ.disWid,ui.sB.disHei,"tY_sQ",ui.sQ.bG,"tY_sQ","");				E.push(e);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}

//function mkL(x,y,w,h,id,co,
////function mkT(x,y,id,co,cl,fonSiz,txt,fonFam,anc){ 
//function mkT(x,y,id,co,cl,fonSiz,txt,fonFam,anc,op){ 
function mosaicTextColor(c){ if(c.v > 68){ return "#000000"} else{ return "#ffffff"}}
function mkMoodPlane(){ var e; var E=[]; var R=2*AL.pE.mo.bE.reso + 1;
	var w=ui.mO.plW/R-(ui.tY.cMarg/(R/2)); var h=ui.mO.plH/R-(ui.tY.cMarg/(R/2));
	var q=AL.pE.mo.qU; var X=ui.mO.plX+(ui.tY.cMarg); var Y=ui.mO.plY+(ui.tY.cMarg);
	e=mkL(ui.mO.plX, ui.mO.plY, ui.mO.plW, ui.mO.plH,"mO_plane-","#000000","mO_plane"); E.push(e);
	var Q=mkNullMatrix(R,R);
	for(var y=0; y<q.length; y++){
		for(var x=0; x<q[y].length; x++){
			Q[y][x] = hsvToRgb(q[y][x].h, q[y][x].s, q[y][x].v);
			Q[y][x] = rgbToHex(Q[y][x].r, Q[y][x].g, Q[y][x].b);
			e=mkL(w*x+X, h*y+Y, w, h, "test", Q[y][x]);	E.push(e);
			e=mkT(w*x+X+3, h*y+Y-h/8, "test", mosaicTextColor(q[y][x]), "test",h/2,"Q: "+AL.pE.mo.qU[y][x].Q,
				"profont", false, 1/1.618); E.push(e);
			e=mkT(w*x+X+3, h*y+Y-(h/8)+(h/2), "test", mosaicTextColor(q[y][x]), "test",h/2,"K: "+AL.pE.mo.qU[y][x].K,
				"profont", false, 1/1.618); E.push(e);
			/*e=mkT(w*x+X+1, h*y+Y-5+(h/3), "test", mosaicTextColor(q[y][x]), "test",h*(2/3),AL.pE.mo.qU[y][x].Q ,"StrikeFighter");*/ E.push(e);}}
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV); }
function moodKey( e){
	if(AL.pE){
		var pM= parseInt(e.id.split("-").pop()); pM=AL.PrimalMoods.seed[pM]; pM=mkPrimalMood(pM, OM.ab);
		var bE= mkBeing(AL.pE.mo.bE.ni);
		AL.pE.mo =combineMoodAndBeing(pM, bE);
		AL.mO = AL.pE.mo;
		AL.bE = AL.pE.mo.bE;
		AL.pM = AL.pE.mo.pM;
		clearScreen(); draw();}}
// if sym mood then priority at getting turn
function beingKey( e){
	if(AL.pE){
		var bE= parseInt(e.id.split("-").pop()); bE=AL.Beings.seed[bE]; bE=mkBeing(bE,OM.ab);
		if((AL.pE.mo.bE.male != bE.male)||(AL.pE.mo.bE.adult != bE.adult)) {
			if(bE.adult){ 	AL.pE.ni.first = dataRandomGivenName(AL.pE.ni.nationality, bE.male);
							AL.pE.ni.name = AL.pE.ni.first+" "+AL.pE.ni.surname;}
			else{ 			AL.pE.ni.first = dataRandomGivenName(AL.pE.ni.nationality, bE.male, false);
							AL.pE.ni.name = AL.pE.ni.first+" "+AL.pE.ni.surname;}}
		var pM= mkPrimalMood(AL.pE.mo.pM.ni);
		AL.pE.mo =combineMoodAndBeing(pM, bE);
		AL.mO = AL.pE.mo;
		AL.bE = AL.pE.mo.bE;
		AL.pM = AL.pE.mo.pM;
		clearScreen(); draw(); }
	else if( AL.bE==null){ AL.bE=bE;} else if(AL.bE!=bE){AL.bE=bE} else { AL.bE=null}}
function mkMoodKeys(){ var e; var E=[]; var keyC=""; var keyS=""; var symC="";
	for(let n=0; n<OM.ab.pMs.length; n++){
		var m=combineMoodAndBeing(OM.ab.pMs[n], AL.bE );
		if((AL.pM==null)||(OM.ab.pMs[n].ni != AL.pM.ni)){ keyC=ui.mO.key2; 		keyS=ui.mO.stroke2 }
		else 											{ keyC=ui.mO.selKey2; 	keyS=ui.mO.selTxt }
		if(m.symm){ symC = "#ffff00"; } else{ symC = ui.mO.selTxt}
		//if(AL.mO.symm){ keyS="#ffff00"}
		e=mkL(ui.mO.kex+(n*(ui.mO.keW+ui.tY.keyGap)), ui.tY.keY, ui.mO.keW-1,ui.tY.keyWid-1,
			"mO_mKey-"+n,keyC,"mO_mKeys",keyS,2); E.push(e);
		e=mkT(ui.mO.kex+(ui.mO.keW/2)+(n*(ui.mO.keW+ui.tY.keyGap)), ui.tY.keY+ui.tY.cMarg/4,
			"mO_mKeyTxt",symC,"mO_mKeyTxt-",0.5*ui.tY.keyWid,OM.ab.pMs[n].niH+OM.ab.pMs[n].niB+OM.ab.pMs[n].niT,"arial","middle"); E.push(e);} //OM.re.people[n].mo.niH+OM.re.people[n].be.nI+OM.re.people[n].mo.niT
	for(let n=0; n<OM.ab.bEs.length; n++){
		if((AL.bE==null)||(OM.ab.bEs[n].ni != AL.bE.ni)){ keyC=ui.mO.key2; 		keyS=ui.mO.stroke2 }
		else 											{ keyC=ui.mO.selKey2; 	keyS=ui.mO.selTxt }
		e=mkL(ui.mO.kex+(n*(ui.mO.keW+ui.tY.keyGap)), ui.tY.keY-ui.tY.keyWid-ui.tY.cMarg, ui.mO.keW-1, ui.tY.keyWid-1,
			"mO_bKey-"+n,keyC,"mO_bKeys",keyS,2); E.push(e);
		e=mkT(ui.mO.kex+(ui.mO.keW/2)+(n*(ui.mO.keW+ui.tY.keyGap)), ui.tY.keY-ui.tY.keyWid-ui.tY.cMarg,
			"mO_bKeyTxt",ui.mO.selTxt,"mO_bKeyTxt-",0.7*ui.tY.keyWid,OM.ab.bEs[n].nI,"times new roman","middle"); E.push(e); }
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);
	bindMany( '.mO_mKeys', function(ev,e) { switch(ev){ case "mousedown" 	: moodKey( e);	break;}});
	bindMany( '.mO_bKeys', function(ev,e) { switch(ev){ case "mousedown" 	: beingKey( e);	break;}});}

function mkMoodDisp(){ var e; var E=[]; var mFDC=""; var lHead, rHead, lMF, rMF, lAriQ, rAriQ, lAriK, rAriK = "";
	if(AL.mO.symm){ mFDC="#ffff00"} else{ mFDC="#00ff00"}
	if( AL.mO.bE.male){ lHead="Bad"; rHead="Good"; lMF=AL.mO.bMF; rMF=AL.mO.gMF;
		lAriQ=AL.mO.bAriQ; rAriQ=AL.mO.gAriQ; lAriK=AL.mO.bAriK; rAriK=AL.mO.gAriK;}
	else{ 					lHead="Good"; rHead="Bad"; lMF=AL.mO.gMF; rMF=AL.mO.bMF;
		lAriQ=AL.mO.gAriQ; rAriQ=AL.mO.bAriQ; lAriK=AL.mO.gAriK, rAriK=AL.mO.bAriK;}

	e=mkL(ui.mO.kex, ui.mO.plY, ui.mO.disWid, ui.mO.taH, undefined, ui.mO.key); E.push(e);

	//e=mkI(ui.mO.kex, ui.mO.plY, ui.mO.kex, ui.mO.disHei, "", ui.mO.key, 4); E.push(e);
	e=mkI(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY, ui.mO.kex+(ui.mO.disWid/2), ui.mO.taH+ui.mO.plY, "", ui.mO.base, 4); E.push(e);
	//e=mkI(ui.mO.kex+ui.mO.disWid, ui.mO.plY, ui.mO.kex+ui.mO.disWid, ui.mO.disHei, "", ui.mO.key, 4); E.push(e);

	e=mkL(ui.mO.kex, ui.mO.plY+ui.mO.tRL, ui.mO.disWid, ui.mO.tRH,
		"mO_disp-binder", ui.mO.key, "mO_disp", ui.mO.base,4); E.push(e);

	e=mkL(ui.mO.kex, ui.mO.plY+ui.mO.tRL+ui.mO.tRH, ui.mO.disWid, ui.mO.tRH,
		"mO_disp-binder", ui.mO.key, "mO_disp", ui.mO.base,4); E.push(e);

	e=mkL(ui.mO.kex, ui.mO.plY+ui.mO.tRL+(2*ui.mO.tRH), ui.mO.disWid, ui.mO.tRH,
		"mO_disp-binder", ui.mO.key, "mO_disp", ui.mO.base,4); E.push(e);

	e=mkL(ui.mO.kex+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,
		"mO_disp",ui.mO.selKey,"mO_disp",ui.mO.stroke3,1,ui.tY.cMarg,ui.tY.cMarg/1.618); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid/4, 	 ui.mO.plY+ui.mO.tRL+(ui.mO.fRH2/1.3), "mO_dispTxt-gMF",
		mFDC,	"mO_dispTxt",	0.7*ui.mO.fRH2, lMF, "times new roman", "middle"); E.push(e);
	e=mkL(ui.mO.kex+ui.mO.disWid/2+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,
		"mO_disp",ui.mO.selKey,"mO_disp",ui.mO.stroke3,1,ui.tY.cMarg,ui.tY.cMarg/1.618); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), 	ui.mO.plY+ui.mO.tRL+(ui.mO.fRH2/1.3), "mO_dispTxt-bMF",
		mFDC, "mO_dispTxt", 0.7*ui.mO.fRH2, rMF, "times new roman", "middle"); E.push(e);

	e=mkL(ui.mO.kex+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+ui.mO.tRH+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,
		"mO_disp",ui.mO.dis,"mO_disp",ui.mO.disStr,1); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid/4, 	 ui.mO.plY+ui.mO.tRL+ui.mO.tRH+(ui.mO.fRH2/1.3),
		"mO_dispTxt-gQ",	"#ffff00",	"mO_dispTxt", 0.7*ui.mO.fRH2, lAriQ, "profont", "middle"); E.push(e);
	e=mkL(ui.mO.kex+ui.mO.disWid/2+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+ui.mO.tRH+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,"mO_disp",ui.mO.dis,"mO_disp",ui.mO.disStr,1); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), ui.mO.plY+ui.mO.tRL+ui.mO.tRH+(ui.mO.fRH2/1.3),
		"mO_dispTxt-bQ",	"#ffff00",	"mO_dispTxt",	0.7*ui.mO.fRH2, rAriQ, "profont", "middle"); E.push(e);

	e=mkL(ui.mO.kex+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+(ui.mO.tRH*2)+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,
		"mO_disp",ui.mO.dis,"mO_disp",ui.mO.disStr,1); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid/4, ui.mO.plY+ui.mO.tRL+(ui.mO.tRH*2)+(ui.mO.fRH2/1.3),
		"mO_dispTxt-gK",	"#ffff00",	"mO_dispTxt",	0.7*ui.mO.fRH2, lAriK, "profont", "middle"); E.push(e);
	e=mkL(ui.mO.kex+ui.mO.disWid/2+(ui.tY.cMarg/1.618), ui.mO.plY+ui.mO.tRL+(ui.mO.tRH*2)+(ui.mO.fRH2/1.3),
		ui.mO.disWid/2-(2*(ui.tY.cMarg/1.618)), ui.mO.fRH2,
		"mO_disp",ui.mO.dis,"mO_disp",ui.mO.disStr,1); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), ui.mO.plY+ui.mO.tRL+(ui.mO.tRH*2)+(ui.mO.fRH2/1.3),
		"mO_dispTxt-bK",	"#ffff00",	"mO_dispTxt",	0.7*ui.mO.fRH2, rAriK, "profont", "middle"); E.push(e);

	/*e=mkL(ui.mO.kex, ui.mO.plY, ui.mO.disWid, 2*ui.tY.cMarg,
		"mO_disp-heading", ui.mO.disStr, "mO_disp"); E.push(e);*/
	e=mkT(ui.mO.kex+(ui.mO.disWid/4), ui.mO.plY, "mO_disp-good", ui.mO.stroke, "mO_disp",
		ui.mO.fRL2/2, "Horizontal", "profont", "middle"); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), ui.mO.plY, "mO_disp-good", ui.mO.stroke, "mO_disp",
		ui.mO.fRL2/2, "Vertical", "profont", "middle"); E.push(e);
	e=mkT(ui.mO.kex+(ui.mO.disWid/4), ui.mO.plY+(ui.mO.fRL2/2.5), "mO_disp-good", ui.mO.stroke, "mO_disp",
		ui.mO.fRL, lHead, "StrikeFighter", "middle"); E.push(e);
	e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), ui.mO.plY+(ui.mO.fRL2/2.5), "mO_disp-good", ui.mO.stroke, "mO_disp",
		ui.mO.fRL, rHead, "StrikeFighter", "middle"); E.push(e);

	e=mkT(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL-2, "mO_disp-good", ui.mO.hilTxt, "mO_disp",
		ui.mO.fRH2/1.618, "Mosaic Form", "profont", "middle"); E.push(e);
	/*e=mkT(ui.mO.kex+ui.mO.disWid-(ui.mO.disWid/4), ui.mO.plY+(2*ui.tY.cMarg), "mO_disp-good", ui.mO.selKey, "mO_disp",
		ui.tY.cMarg, "Modal Form", "profont", "middle"); E.push(e);*/

	e=mkT(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL+ui.mO.tRH-2, "mO_disp-good", ui.mO.hilTxt, "mO_disp",
		ui.mO.fRH2/1.618, "Quality", "profont", "middle"); E.push(e);

	e=mkT(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL+(2*ui.mO.tRH)-2, "mO_disp-good", ui.mO.hilTxt, "mO_disp",
		ui.mO.fRH2/1.618, "Karma", "profont", "middle"); E.push(e);

	e=mkI(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL+ui.mO.fRH2,
		ui.mO.kex+(ui.mO.disWid/2), ui.mO.tRL+ui.mO.tRH+ui.mO.plY, "", ui.mO.base, 4); E.push(e);

	e=mkI(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL+ui.mO.tRH+ui.mO.fRH2,
		ui.mO.kex+(ui.mO.disWid/2), ui.mO.tRL+ui.mO.tRH+ui.mO.tRH+ui.mO.plY, "", ui.mO.base, 4); E.push(e);

	e=mkI(ui.mO.kex+(ui.mO.disWid/2), ui.mO.plY+ui.mO.tRL+(2*ui.mO.tRH)+ui.mO.fRH2,
		ui.mO.kex+(ui.mO.disWid/2), ui.mO.tRL+(3*ui.mO.tRH)+ui.mO.plY, "", ui.mO.base, 4); E.push(e);

	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV); }

function mkMoodStage(){ 
if(AL.pE!=null){ var E=[]; var e=null; var x=ui.tY.cuHrz-(ui.tY.cMarg/2); var mFS="";
	if(AL.mO.symm){ mFS="#ffff00"} else{ mFS="#88ff88"}
	var mDisp = AL.pE.mo.pM.niH + AL.pE.mo.bE.nI + AL.pE.mo.pM.niT
	var e=mkT(ui.tY.keX-ui.sB.disWid, ui.tY.stY-ui.tY.cE/12, "-stg", mFS, "stg", ui.tY.cE/6,AL.pE.ni.name, "profont","left");E.push(e);
	var e=mkT(x, ui.tY.stY-(ui.tY.cE/2.5), "-stg", mFS, "stg", (2*ui.tY.cE)/8, AL.mO.nI, "tahoma","middle");
	e.setAttribute("filter","url(#f1)"); E.push(e);
	var e=mkT(x, ui.tY.stY-(ui.tY.cE/2.5), "-stg", mFS, "stg", (2*ui.tY.cE)/8, AL.mO.nI, "tahoma","middle");
	e.setAttribute('opacity',0.62);E.push(e);
	var e=mkT(ui.winWid-ui.tY.cMarg-ui.sB.disWid, ui.tY.stY-ui.tY.cE/12, "", mFS, "", ui.tY.cE/6, mDisp, "times new roman","end"); E.push(e);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);}}
function drawMood(){var buf =null;
	buf =mkL(ui.tY.disHrz,ui.tY.disVrt,ui.tY.disWid,ui.tY.disHei,"tY",ui.mO.base,"tY","");
	sV.appendChild(buf); document.body.appendChild( sV);
	mkMoodPlane();
	mkMoodKeys();
	mkMoodDisp();
	mkMoodStage();
	mkTopBar();
	mkTypeList();
	mkBottomBar();}

function chunkArray(myArray, chunk_size){
	var index = 0;
	var arrayLength = myArray.length;
	var tempArray = [];    
	for (index = 0; index < arrayLength; index += chunk_size) {
		myChunk = myArray.slice(index, index+chunk_size);
		tempArray.push(myChunk);}
	return tempArray;}

function mosaicKeyMouseOver(mX,mY) 	{ previewMove( mX, mY)}
function mosaicKeyMouseDown(mX,mY) 	{ AL.moved =attemptMove( mX, mY)}
function mosaicKeyMouseUp() 		{ if(AL.moved){ processSubTurn( AL.sim); AL.moved=false}}

function mkMosaicDisp(){
	var pC, tC;
	var pRow=2; var pCol=1;	if(AL.sim.people.length > 2){ pRow=4; pCol=2} if(AL.sim.people.length > 8){ pRow=6; pCol=3}
	var w= Math.floor(ui.mC.disWid/(4*AL.pE.mo.bE.reso+2)); // tile width
	var h= Math.floor((ui.winHei-ui.bB.disHei)/(4*AL.pE.mo.bE.reso+2)); // tile height
	var X= Math.round((ui.mC.disWid-((4*AL.pE.mo.bE.reso+2)*w))/2)+ui.mC.liW; // screen offset x
	var Y= Math.round(((ui.winHei-ui.bB.disHei)-((4*AL.pE.mo.bE.reso+2)*h))/2); // screen offset y
	var pW=Math.floor((w-pRow)/pRow)-1; // person width
	var pH=Math.floor((h-pCol)/pCol)-1; // person height
	var fOff=2; if(pH < 9){ fOff=1}
	var c; var e; var E=[]; var E2=[];
	for(var y=0; y<4*AL.personInTurn.mo.bE.reso+2; y++){ for(var x=0; x<4*AL.personInTurn.mo.bE.reso+2; x++){
		c =AL.personInTurn.mo.mC[y][x];
		c = hsvToRgb(c.h, c.s, c.v);
		c = rgbToHex(c.r, c.g, c.b);
		e=mkL(w*x+X, h*y+Y, w, h, "mC_"+x+"-"+y, c, "mC", "#666", 1); E.push(e);
		if(AL.personInTurn.mCppl[y][x]){
			var ppl =chunkArray(AL.personInTurn.mCppl[y][x],pRow);
			for(var i=0; i<ppl.length;i++){
				for(var j=0; j<ppl[i].length;j++){
					pC=ppl[i][j].mo.mC[y][x];
					tC=mosaicTextColor(pC);
					pC=hsvToRgb( pC.h, pC.s, pC.v);
					pC=rgbToHex( pC.r, pC.g, pC.b);
					e=mkL(w*x+X+(j*(pW+1))+j+1, h*y+Y+(i*(pH+1))+1, pW, pH,
						"",pC, "mC_P",tC,undefined,false,3,3);
					E2.push(e);
					e=mkT(w*x+X+(j*(pW+1))+(pW/2)+j+2, h*y+Y+(i*(pH+1))-fOff,
						"",tC,"mC_PT",pH,ppl[i][j].ni.in,"profont","middle");
					E2.push(e);	}}}}}
	E=E.concat(E2);
	E.forEach( function(E){sV.appendChild(E)}); document.body.appendChild( sV);
	bindMosaic( '.mC', function(ev,e) {
		var mX=e.id.split("_").pop(); var mY=parseInt(mX.split("-").pop()); mX=parseInt(mX.split("-")[0]);
		switch(ev){ case "mouseover" 	: mosaicKeyMouseOver( mX,mY); 				break;
					case "mousedown" 	: mosaicKeyMouseDown( mX,mY); 				break;
					case "mouseup" 		: mosaicKeyMouseUp( ); 						break;
					case "mouseleave" 	: mosaicKeyMouseUp( ); 						break;}})}
function drawMosaic(){ var buf=null;
	mkTypeList(true);
	mkMosaicDisp();
	mkBottomBar();
}



function resizeWindow(){ clearScreen();predraw();draw()}
window.addEventListener("resize", resizeWindow, true);

OM.re = { people:[], sims:[]};
OM.ab = {};

function doEvent(e){

	console.log(e.mX); console.log(e.mY);
	for(var n=0; n<e.subject.ppl.length; n++){
		if(e.subject.ni.in ==e.subject.ppl[n]){
			e.subject.mo.x = e.vX; e.subject.mo.y = e.vY;
			e.subject.mo.mX= e.mX; e.subject.mo.mY= e.mY}
		else{
			e.subject.ppl[n].mo.x += e.vX; e.subject.ppl[n].mo.y += e.vY;
			e.subject.ppl[n].mo.mX += e.vX;e.subject.ppl[n].mo.mY-=e.vY; }}
	//precalcOthers(e.sim.people);
	clearMosaic(e.sim.personInTurn);
	console.log(e.sim.personInTurn.mo.mC);
	for(var n=0; n<e.sim.personInTurn.ppl.length; n++){ populateMosaic(e.sim.personInTurn, e.sim.personInTurn.ppl[n])}
	clearScreen();
	draw();

	//for(var n=0; n<e.sim.people.length; n++){ e.sim.people[n].mX += e.vX; e.sim.people[n].mY += e.vY;}
	//processSubTurn(e.sim, e)
}
function Event(sim,pe,mX,mY,mVX,mVY,vX,vY){
	this.subject=pe; this.mX=mX; this.mY=mY; this.vX=vX; this.vY=vY; this.mVX=mVX; this.mVY=mVY;
	this.sim=sim; sim.events.push(this); doEvent(this)}

function calcBeing(gnd,kid){ var r;
	if(typeof kid != 'undefined'){ if(gnd){ r =mkBeing("mas"), OM.ab} else{ r =mkBeing("fem"), OM.ab}}
	else 	{if(gnd){ r =mkBeing("MAS"), OM.ab} else{ r =mkBeing("FEM"), OM.ab}} return r}
function precalcPeople(){ var bu=null; var a=[];
	bu=mkPerson(true,true); 				OM.re.people.push(bu);
	bu=mkPerson(false,true); 				OM.re.people.push(bu); 
	bu=mkPerson(true,false); 				OM.re.people.push(bu); 
	bu=mkPerson(false,false); 				OM.re.people.push(bu); 
	bu=mkPerson(true,true,false,false); 	OM.re.people.push(bu); 
	bu=mkPerson(false,true,false,false); 	OM.re.people.push(bu); 
	bu=mkPerson(true,false,false,false); 	OM.re.people.push(bu); 
	bu=mkPerson(false,false,false,false);	OM.re.people.push(bu);
}
function precalcOthers(ppl){ var ret=[]; var buf=null;
	for(var i=0; i<ppl.length; i++){
		if(ppl[i].ni.in == AL.personInTurn.ni.in){ ret.push(ppl[i])}
		else{ buf=mkOther(ppl[i]); ret.push(buf)}}
	//console.log(ret);
	AL.personInTurn.ppl = ret;}
function initTypeState( tY){ /*console.log(tY)*/}
function initOtherMosaicState(ot){
	if ( ot.mo.bE.male) { ot.mo.x =pe.mo.bE.reso*3+1;  	pe.mo.y =pe.mo.bE.reso}
	else 				{ ot.mo.x =pe.mo.bE.reso*3+1; 	pe.mo.y =pe.mo.bE.reso*3+1}}
function initMosaicState( pe,ppl){ var buf=null; var oT=[];
	if ( pe.mo.bE.male) { pe.mo.x =pe.mo.bE.reso;  		pe.mo.y =pe.mo.bE.reso}
	else 				{ pe.mo.x =pe.mo.bE.reso*3+1; 	pe.mo.y =pe.mo.bE.reso}
	ppl.forEach( function(p){ if(p.ni.in != pe.ni.in){ buf =mkOther(p); oT.push(buf);	}});
	pe.oT = oT}
function getMood(pe){ var mood ="_";
	if(pe.mo.pM.head){ mood = "n"+mood }
	mood = mood + pe.mo.bE.ni + "_";
	for(let n=0; n < pe.mo.pM.tail.length; n++){
		switch(pe.mo.pM.tail[n]){ 	case "+" : mood = mood + "p"; break;
									case "-" : mood = mood + "n"; break;
									case "x" : mood = mood + "b"; break;}}
	pe.mo = mkMood(mood, OM.ab)}
function mkPerson(nat,gnd,w1,w2){
	var ni = dataInventFullName(nat,gnd,w1,w2); //console.log(ni);
	//var ty = OM.ab.tYs[Math.floor(Math.random()*(OM.ab.tYs.length-1))]; //console.log(ty);
	var ty = precalcSociotype( AL.Sociotypes.seed[Math.floor(Math.random()*(OM.ab.tYs.length-1))], OM.ab);
	var pm = mkPrimalMood( AL.PrimalMoods.seed[Math.floor(Math.random()*(OM.ab.pMs.length))], OM.ab);
	var be = calcBeing(gnd,w1);
	var ind = (OM.re.people.length + 10).toString(36).toUpperCase(); //console.log(ind);
	var re = new Person(ni,ty,pm,be,ind); return re}
function mkPerson2(pe){
	getMood(pe);
	mkMosaic(pe,false);
	if(pe.mo.bE.male){
		pe.mo.mX = pe.mo.bE.reso;
		pe.mo.mY = pe.mo.bE.reso}
	else{
		pe.mo.mX = pe.mo.bE.reso;
		pe.mo.mY = (3*pe.mo.bE.reso)+1}}
function mkOther(pe){
	var ni= _.cloneDeep(pe.ni);
	var ty = _.cloneDeep(pe.ty);
	var mo = _.cloneDeep(pe.mo);
	var re = new Other(ni,ty,mo);  return re}
function mkOther2(pe){
	mkMosaic(pe,true);
	pe.mo.mX += (2*pe.mo.bE.reso)+1;
	/*if(pe.mo.bE.male){
		pe.mo.mX = (3*pe.mo.bE.reso)+1;
		pe.mo.mY = pe.mo.bE.reso}
	else{
		pe.mo.mX = (3*pe.mo.bE.reso)+1;
		pe.mo.mY = (3*pe.mo.bE.reso)+1}*/}
function Other(ni,ty,mo){ this.ni =ni; this.ty =ty; this.mo =mo; mkOther2(this)}
function Person(ni,ty,pm,be,ind){ this.ni =ni; this.ty =ty; this.mo ={pM:pm, bE:be}; this.ni.in =ind; mkPerson2(this);}

// devBar usage: 

function interleaveDomains(R,lM,rM) { var r = (2*R)+1; var X = 2*r; var Y = r; var m = mkNullMatrix(Y,X);
	for(var y=0; y<Y; y++){	for(var x=0; x<X; x++) { if(x<r) { m[y][x] = lM[y][x] }
													 else 	 { m[y][x] = rM[y][x-r] }}} return m }
function mkMosaic(pe,o){ var mC ={ };
	if(!o){
		if ( pe.mo.bE.male) {
			mC.uL = pe.mo.qU;
			mC.uR = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.uR[n].reverse()}
			mC.dL = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			mC.dR = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.dR[n].reverse()}
			mC.u = interleaveDomains( pe.mo.bE.reso, mC.uL, mC.uR);
			mC.d = interleaveDomains( pe.mo.bE.reso, mC.dL, mC.dR);
			pe.mo.mC = mC.u.concat(mC.d);
			}
		else 				{
			mC.uL = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			mC.uR = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.uR[n].reverse()}
			mC.dL = pe.mo.qU;
			mC.dR = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.dR[n].reverse()}
			mC.u = interleaveDomains( pe.mo.bE.reso, mC.uL, mC.uR);
			mC.d = interleaveDomains( pe.mo.bE.reso, mC.dL, mC.dR);
			pe.mo.mC = mC.u.concat(mC.d)}}
	else{
		if ( pe.mo.bE.male) {
			mC.uR = pe.mo.qU;
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.uR[n].reverse()}
			mC.uL = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			mC.dL = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			mC.dR = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.dR[n].reverse()}
			mC.u = interleaveDomains( pe.mo.bE.reso, mC.uL, mC.uR);
			mC.d = interleaveDomains( pe.mo.bE.reso, mC.dL, mC.dR);
			pe.mo.mC = mC.u.concat(mC.d);
			}
		else 				{
			mC.uL = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			mC.uR = mkXYPlaneTemplate( pe.mo.bE.reso,true);
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.uR[n].reverse()}
			mC.dR = pe.mo.qU;
			for(var n=0; n<2*pe.mo.bE.reso+1; n++){ mC.dR[n].reverse()}
			mC.dL = mkXYPlaneTemplate( pe.mo.bE.reso,false);
			mC.u = interleaveDomains( pe.mo.bE.reso, mC.uL, mC.uR);
			mC.d = interleaveDomains( pe.mo.bE.reso, mC.dL, mC.dR);
			pe.mo.mC = mC.u.concat(mC.d)}}}


function evalQuantity(ari){ var ret=null;
	switch( ari ) { case "-X" 	: ret =function(R,X,Y){ return -X 	};break;
					case "X" 	: ret =function(R,X,Y){ return X 	};break;
					case "-Y" 	: ret =function(R,X,Y){ return -Y 	};break;
					case "Y" 	: ret =function(R,X,Y){ return Y 	};break;
					case "X - Y": ret =function(R,X,Y){ return X - Y};break;
					case "Y - X": ret =function(R,X,Y){ return Y - X};break;
					case "X - R": ret =function(R,X,Y){ return X - R};break;
					case "R - X": ret =function(R,X,Y){ return R - X};break;
					case "Y - R": ret =function(R,X,Y){ return Y - R};break;
					case "R - Y": ret =function(R,X,Y){ return R - Y};break;} return ret}
function evalXYPlane(m){ var bK, gK, bQ, gQ =null;
	bK =evalQuantity(m.bAriK); gK =evalQuantity(m.gAriK); bQ =evalQuantity(m.bAriQ); gQ =evalQuantity(m.gAriQ);
	if(m.bE.male){ for(var y=0; y<2*m.bE.reso+1; y++){ for(var x=0; x<2*m.bE.reso+1; x++){
		if 		( m.qU[y][x].X <= m.qU[y][x].Y ) {  m.qU[y][x].Q = gQ( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
													if( m.qU[y][x].Q == 0){ m.qU[y][x].Q == +0}
													m.qU[y][x].K = gK( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
													if( m.qU[y][x].K == 0){ m.qU[y][x].K == +0}}
	 	else if ( m.qU[y][x].X  > m.qU[y][x].Y ) {  m.qU[y][x].Q = bQ( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
	 												if( m.qU[y][x].Q == 0){ m.qU[y][x].Q == -0}
	 												m.qU[y][x].K = bK( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
	 												if( m.qU[y][x].K == 0){ m.qU[y][x].K == -0}}}}}
	else 		 { for(var y=0; y<2*m.bE.reso+1; y++){ for(var x=0; x<2*m.bE.reso+1; x++){
		if 		( m.qU[y][x].Y <= m.qU[y][x].X ) {  m.qU[y][x].Q = gQ( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
													if( m.qU[y][x].Q == 0){ m.qU[y][x].Q == +0}
													m.qU[y][x].K = gK( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
													if( m.qU[y][x].K == 0){ m.qU[y][x].K == +0}}
	 	else if ( m.qU[y][x].Y  > m.qU[y][x].X ) {  m.qU[y][x].Q = bQ( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
	 												if( m.qU[y][x].Q == 0){ m.qU[y][x].Q == -0}
	 												m.qU[y][x].K = bK( m.bE.reso, m.qU[y][x].X, m.qU[y][x].Y);
	 												if( m.qU[y][x].K == 0){ m.qU[y][x].K == -0}}}}}}
function mapXYPlane(q,r){ for(var y=0; y<r*2+1; y++){ for(var x=0; x<r*2+1; x++){
	q[y][x].x =x-r; q[y][x].y =y-r; q[y][x].X=Math.abs(q[y][x].x); q[y][x].Y=Math.abs(q[y][x].y);}}}
function hsvToRgb(h, s, v) {
	var r, g, b;	var i;	var f, p, q, t;
	h = Math.max(0, Math.min(360, h));	s = Math.max(0, Math.min(100, s));	v = Math.max(0, Math.min(100, v));
	s /= 100;	v /= 100;
	if(s == 0) { r = g = b = v;	return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];}
	h /= 60; // sector 0 to 5
	i = Math.floor(h);
	f = h - i; // factorial part of h
	p = v * (1 - s);
	q = v * (1 - s * f);
	t = v * (1 - s * (1 - f));
	switch(i) {		case 0:			r = v;			g = t;			b = p;			break;
					case 1:			r = q;			g = v;			b = p;			break;
					case 2:			r = p;			g = v;			b = t;			break;
					case 3:			r = p;			g = q;			b = v;			break;
					case 4:			r = t;			g = p;			b = v;			break;
					default:/*case 5*/r = v;		g = p;			b = q;	}
	return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255)}}
function RGBtoHSV(r, g, b) { if (arguments.length === 1) { g = r.g, b = r.b, r = r.r; }
    var max = Math.max(r, g, b), min = Math.min(r, g, b), d = max - min, h, s = (max === 0 ? 0 : d / max), v = max / 255;
    switch (max) { case min: h = 0; break; case r: h = (g - b) + d * (g < b ? 6: 0); h /= 6 * d; break;
        case g: h = (b - r) + d * 2; h /= 6 * d; break; case b: h = (r - g) + d * 4; h /= 6 * d; break}
    return { h: h, s: s, v: v }}
function componentToHex(c) { var hex = c.toString(16); return hex.length == 1 ? "0" + hex : hex}
function rgbToHex(r, g, b) { return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);}
function hexToRgb(hex) { var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
	return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16)} : null}

function blendColours2(src,dst,r){ var buf=null; var ret=[];
	var s =chunkify2(src.s, dst.s, r);	var v =chunkify(src.v, dst.v, r);	var h =chunkify(src.h, dst.h, r);
	for(var n=0; n<r; n++){ buf ={ h:h[n], s:s[n], v:v[n]}; ret.push(buf)}	return ret }
function chunkify2(src,dst,r){ 	var min =Math.max(src,dst);	var max =Math.min(src,dst);
								var range = max-min;		var chunk = Math.round(range/(r-1));
	var ret=[];	for(var n=0; n<r; n++){ ret.push(n*chunk + min)} return ret}
function blendColours(src,dst,r){ var buf=null; var ret=[];
	var s =chunkify(src.s, dst.s, r);	var v =chunkify(src.v, dst.v, r);	var h =chunkify(src.h, dst.h, r);
	for(var n=0; n<r; n++){ buf ={ h:h[n], s:s[n], v:v[n]}; ret.push(buf)}	return ret }
function chunkify(src,dst,r){ 	var min =Math.min(src,dst);	var max =Math.max(src,dst);
								var range = max-min;		var chunk = Math.round(range/(r-1));
	var ret=[];	for(var n=0; n<r; n++){ ret.push(n*chunk + min)} return ret}
function mkNullMatrix(y,x){	var q=[];
	for(var n=0; n<y; n++){
		q.push([]);
		if(x){ for(var m=0; m<x; m++){	q[n].push(null)}}
		else { for(var m=0; m<y; m++){	q[n].push(null)}}} return q}

function interleaveQuadrants(R,l,v,r) { var X = (2*R)+1; var Y = R; var m = mkNullMatrix(Y,X);
	for(var y=0; y<Y; y++){	for(var x=0; x<X; x++) { if(x<R)  { m[y][x] = l[y][x] }
												else if(x==R) { m[y][x] = v[y][0] }
												else 		  { m[y][x] = m[y][x] = r[y][x-R-1] }}} return m }

function flipHor(m){ var M=mkNullMatrix(m.length);
	for(var n=0; n<M.length; n++){ M[n] = m[n].reverse()} return M}
function flipVer(m){
	var M=mkNullMatrix(m.length); var len=M.length;
	for(var n=0; n<len; n++){ M[len-1-n]=m[n]} return M}
//(ui.ora, true, false, m.bE.reso, m.goodForm);
function rotate(matrix,n) {	var r=Math.ceil(n/2); if(n%2==1) { r--; }
    for (var i = 0; i < n/2; i++) { for (var j = 0; j < r; j++) {
            var temp = matrix[i][j]; matrix[i][j] = matrix[n-1-j][i]; matrix[n-1-j][i] = matrix[n-1-i][n-1-j];
            matrix[n-1-i][n-1-j] = matrix[j][n-1-i]; matrix[j][n-1-i] = temp; }} return matrix }
function flipDiagonal(matrix,n) { for (var i = 0; i < n; i++) { for (var j = 0; j < n; j++) {
        	if(j < i) {	var temp = matrix[j][i]; matrix[j][i] = matrix[i][j]; matrix[i][j] = temp; }}} return matrix }

function fillHalfQuadrant(q,r,reverse,blend2){
	var from; var to; var L; var len;
	for(var y=0; y<r; y++){ L =[]; from=null; to=null;
		for(var x=0; x<r; x++){ if(q[x][y]!=null){
			if(from==null){ from = {y:y, x:x, c:q[x][y] }} else{ to ={ y:y, x:x, c:q[x][y]}}}
		if(from&&to){
			if(blend2){ L=blendColours2(from.c, to.c, to.x-from.x+1);}
			else{ L=blendColours(from.c, to.c, to.x-from.x+1);}
			if(reverse){ L.reverse();}
			for(var n=1; n<to.x; n++){ q[n][y] = L[n]}
			break}}}}
function mkHalfQuadrantTemplate(c,g,r){
	if(!g){ r--}
	var q=mkNullMatrix(r);
	for(var y=0; y<r; y++){
		for(var x=0; x<r-y; x++){
			q[y][x] =c }}
	return q}
function mkHalfQuadrant(c,g,r,mF){
	if(!g){ r--}
	var q=mkNullMatrix(r);
	var fToL=blendColours2(c.f, c.l, r);
	var lToH=blendColours(c.l, c.h, r);
	var fToH=blendColours(c.f, c.h, r);
	switch(mF[0]){ 
		case "a" :
			switch(mF[1]){ 
				case "b" :  
				for(var n=0; n<r; n++){	
					q[0][n] 	= fToL[n];
					q[n][0] 	= fToH[n];
					q[n][r-n-1] = lToH[n]}
					fillHalfQuadrant(q,r);
					break;
				case "c" :
				for(var n=0; n<r; n++){	
					q[0][n] 	= lToH[r-n-1];
					q[n][0] 	= fToH[r-n-1];
					q[n][r-n-1] = fToL[r-n-1]}
					fillHalfQuadrant(q,r,true);
					} break;
		case "b" :
			switch(mF[1]){ 
				case "a" :  
				for(var n=0; n<r; n++){	
					q[0][n] 	= fToL[r-n-1];
					q[n][0] 	= lToH[n];
					q[n][r-n-1] = fToH[n]}
					fillHalfQuadrant(q,r);
					break;
				case "c" :
				for(var n=0; n<r; n++){	
					q[0][n] 	= fToH[r-n-1];
					q[n][0] 	= lToH[r-n-1];
					q[n][r-n-1] = fToL[n]}
					fillHalfQuadrant(q,r,false,true);
					} break;
		case "c" :
			switch(mF[1]){ 
				case "a" :  
				for(var n=0; n<r; n++){	
					q[0][n] 	= lToH[n];
					q[n][0] 	= fToL[r-n-1];
					q[n][r-n-1] = fToH[r-n-1]}
					fillHalfQuadrant(q,r,true,true);
					break;
				case "b" :
				for(var n=0; n<r; n++){	
					q[0][n] 	= fToH[n];
					q[n][0] 	= fToL[n];
					q[n][r-n-1] = lToH[r-n-1]}
					fillHalfQuadrant(q,r,false,true);
					} break;} return q}
function mkXYColumn(c,r){ 	var a=[]; var b;for(var n=0; n<r; n++){ b={h:c.h, s:c.s, v:c.v}; a.push([b])} 	return a}
function mkXYRow(c,r){ 		var a=[]; var b;for(var n=0; n<r; n++){ b={h:c.h, s:c.s, v:c.v}; a.push(b)} 	return a}
function offsetDownwards(m,r){	var a=[]; 	for(var n=0; n<r; n++){ a.push(null)}	m.unshift(a);}
function offsetRightwards( m,r){				for(var n=0; n<r; n++){					m[n].unshift(null)}}
function offsetUpwards( m,r){	var a=[];	for(var n=0; n<r; n++){	a.push(null)}	m.push(a);}
function offsetLeftwards( m,r) { 				for(var n=0; n<r; n++){ 				m[n].push(null)}}
function connectHalfQuadrants(master,slave,r){
	for(var y=0; y<r; y++){	for(var x=0; x<r; x++){	if(master[x][y]==null){ master[x][y] =slave[x][y]}}} return master}
function mkXYPlaneTemplate(r,male){
	var qU={ };
	if(male){
		qU.uLV = mkHalfQuadrantTemplate(ui.ora.l, true, r);
		 	qU.uLV=rotate(qU.uLV, r);
		qU.uLH = mkHalfQuadrantTemplate(ui.blu.l, false,r);
			qU.uLH =flipDiagonal(rotate( qU.uLH, r-1), r-1);
			offsetDownwards( qU.uLH, r-1);	offsetLeftwards( qU.uLH, r);
		qU.uRV = mkHalfQuadrantTemplate(ui.red.l, true, r);
			qU.uRV=flipDiagonal(qU.uRV, r);
		qU.uRH = mkHalfQuadrantTemplate(ui.cya.l, false,r);
			qU.uRH =rotate(rotate(qU.uRH, r-1), r-1);
			offsetDownwards( qU.uRH, r-1); offsetRightwards( qU.uRH, r);
		qU.dLV = mkHalfQuadrantTemplate(ui.yel.l, true, r);
			qU.dLV =flipDiagonal(rotate(rotate(qU.dLV, r), r), r);
		qU.dLH = mkHalfQuadrantTemplate(ui.vio.l, false,r);
			offsetUpwards( qU.dLH, r-1); offsetLeftwards( qU.dLH, r);
		qU.dRV = mkHalfQuadrantTemplate(ui.lil.l, true, r);
			qU.dRV =rotate(rotate(rotate(qU.dRV, r), r), r);
		qU.dRH = mkHalfQuadrantTemplate(ui.gre.l, false,r);
			qU.dRH =flipDiagonal(rotate(rotate(rotate( qU.dRH, r-1), r-1), r-1), r-1);
			offsetUpwards( qU.dRH, r-1); offsetRightwards( qU.dRH, r);

		qU.uL = connectHalfQuadrants( qU.uLV, qU.uLH, r);
		qU.uR = connectHalfQuadrants( qU.uRV, qU.uRH, r);
		qU.dL = connectHalfQuadrants( qU.dLV, qU.dLH, r);
		qU.dR = connectHalfQuadrants( qU.dRV, qU.dRH, r);

		qU.u = mkXYColumn( ui.gra.l, r);
		qU.d = mkXYColumn( ui.gra.l, r);
		qU.l = mkXYRow( ui.gra.h, r);
		qU.r = mkXYRow( ui.gra.h, r);
		qU.c =[{ h: ui.gra.f.h, s: ui.gra.f.s, v: ui.gra.f.v}];

		qU.U = interleaveQuadrants( r, qU.uL, 	qU.u, 	qU.uR);
		qU.C = [qU.l.concat( qU.c).concat(qU.r)]; 					
		qU.D = interleaveQuadrants( r, qU.dL, 	qU.d, 	qU.dR);

		qU = qU.U.concat( qU.C).concat( qU.D);
	}
	else {
		qU.uLH = mkHalfQuadrantTemplate(ui.yel.l, true, r);
			qU.uLH =flipDiagonal(rotate( qU.uLH, r), r);
		qU.uLV = mkHalfQuadrantTemplate(ui.vio.l, false, r);
			qU.uLV =rotate( qU.uLV,r-1);
			offsetRightwards( qU.uLV, r-1); offsetUpwards( qU.uLV, r);
		qU.uRH = mkHalfQuadrantTemplate(ui.ora.l, true, r);
			qU.uRH =rotate(rotate( qU.uRH, r), r);
		qU.uRV = mkHalfQuadrantTemplate(ui.blu.l, false, r);
			qU.uRV =flipDiagonal( qU.uRV, r-1);
			offsetLeftwards( qU.uRV, r-1); offsetUpwards( qU.uRV, r);
		qU.dLH = mkHalfQuadrantTemplate(ui.lil.l, true, r);
		qU.dLV = mkHalfQuadrantTemplate(ui.gre.l, false,r);
			qU.dLV =flipDiagonal(rotate(rotate( qU.dLV, r-1), r-1), r-1);
			offsetRightwards( qU.dLV, r-1); offsetDownwards( qU.dLV, r);
		qU.dRH = mkHalfQuadrantTemplate(ui.red.l, true, r);
			qU.dRH =flipDiagonal(rotate(rotate(rotate( qU.dRH, r), r), r), r);
		qU.dRV = mkHalfQuadrantTemplate(ui.cya.l, false, r);
			qU.dRV =rotate(rotate(rotate( qU.dRV, r-1), r-1), r-1);
			offsetLeftwards( qU.dRV, r-1); offsetDownwards( qU.dRV, r);

		qU.uL = connectHalfQuadrants( qU.uLV, qU.uLH, r);
		qU.uR = connectHalfQuadrants( qU.uRV, qU.uRH, r);
		qU.dL = connectHalfQuadrants( qU.dLV, qU.dLH, r);
		qU.dR = connectHalfQuadrants( qU.dRV, qU.dRH, r);

		qU.u = mkXYColumn( ui.gra.h, r);
		qU.d = mkXYColumn( ui.gra.h, r);
		qU.l = mkXYRow( ui.gra.l, r);
		qU.r = mkXYRow( ui.gra.l, r);
		qU.c =[{ h: ui.gra.f.h, s: ui.gra.f.s, v: ui.gra.f.v}];

		qU.U = interleaveQuadrants( r, qU.uL, 	qU.u, 	qU.uR);
		qU.C = [qU.l.concat( qU.c).concat(qU.r)]; 					
		qU.D = interleaveQuadrants( r, qU.dL, 	qU.d, 	qU.dR);

		qU = qU.U.concat( qU.C).concat( qU.D);	
	}
	return qU}
function mkXYPlane(m){
	var qU={ uLH:null,uLV:null,uRH:null,uRV:null,l:null,c:null,r:null,dLH:null,dLV:null,d:null,dRH:null,dRV:null,
		uL:null, uR:null, dL:null, dR:null};
	if(m.bE.male){
		qU.uLV = mkHalfQuadrant(ui.ora, true, m.bE.reso, m.goodForm);
			qU.uLV=rotate(qU.uLV, m.bE.reso);
		qU.uLH = mkHalfQuadrant(ui.blu, false, m.bE.reso, m.badForm);
			qU.uLH =flipDiagonal(rotate( qU.uLH, m.bE.reso-1), m.bE.reso-1);
			offsetDownwards( qU.uLH, m.bE.reso-1);	offsetLeftwards( qU.uLH, m.bE.reso);
		qU.uRV = mkHalfQuadrant(ui.red, true, m.bE.reso, m.goodForm);
			qU.uRV=flipDiagonal(qU.uRV, m.bE.reso);
		qU.uRH = mkHalfQuadrant(ui.cya, false,m.bE.reso, m.badForm);
			qU.uRH =rotate(rotate(qU.uRH, m.bE.reso-1),m.bE.reso-1);
			offsetDownwards( qU.uRH, m.bE.reso-1); offsetRightwards( qU.uRH, m.bE.reso);
		qU.dLV = mkHalfQuadrant(ui.yel, true, m.bE.reso, m.goodForm);
			qU.dLV =flipDiagonal(rotate(rotate(qU.dLV, m.bE.reso), m.bE.reso), m.bE.reso);
		qU.dLH = mkHalfQuadrant(ui.vio, false,m.bE.reso, m.badForm);
			offsetUpwards( qU.dLH,m.bE.reso-1); offsetLeftwards( qU.dLH, m.bE.reso);
		qU.dRV = mkHalfQuadrant(ui.lil, true, m.bE.reso, m.goodForm);
			qU.dRV =rotate(rotate(rotate(qU.dRV, m.bE.reso), m.bE.reso), m.bE.reso);
		qU.dRH = mkHalfQuadrant(ui.gre, false,m.bE.reso, m.badForm);
			qU.dRH =flipDiagonal(rotate(rotate(rotate( qU.dRH,m.bE.reso-1),m.bE.reso-1),m.bE.reso-1),m.bE.reso-1);
			offsetUpwards( qU.dRH,m.bE.reso-1); offsetRightwards( qU.dRH, m.bE.reso);

		qU.uL = connectHalfQuadrants( qU.uLV, qU.uLH, m.bE.reso);
		qU.uR = connectHalfQuadrants( qU.uRV, qU.uRH, m.bE.reso);
		qU.dL = connectHalfQuadrants( qU.dLV, qU.dLH, m.bE.reso);
		qU.dR = connectHalfQuadrants( qU.dRV, qU.dRH, m.bE.reso);

		qU.u = mkXYColumn( ui.gra.l, m.bE.reso);
		qU.d = mkXYColumn( ui.gra.l, m.bE.reso);
		qU.l = mkXYRow( ui.gra.h, m.bE.reso);
		qU.r = mkXYRow( ui.gra.h, m.bE.reso);
		qU.c =[{ h: ui.gra.f.h, s: ui.gra.f.s, v: ui.gra.f.v}];

		qU.U = interleaveQuadrants( m.bE.reso, qU.uL, 	qU.u, 	qU.uR);
		qU.C = [qU.l.concat( qU.c).concat(qU.r)]; 					
		qU.D = interleaveQuadrants( m.bE.reso, qU.dL, 	qU.d, 	qU.dR);

		qU = qU.U.concat( qU.C).concat( qU.D);
		}
	else{
		qU.uLH = mkHalfQuadrant(ui.yel, true, m.bE.reso, m.goodForm);
			qU.uLH =flipDiagonal(rotate( qU.uLH,m.bE.reso), m.bE.reso);
		qU.uLV = mkHalfQuadrant(ui.vio, false,m.bE.reso, m.badForm);
			qU.uLV =rotate( qU.uLV,m.bE.reso-1);
			offsetRightwards( qU.uLV, m.bE.reso-1); offsetUpwards( qU.uLV, m.bE.reso);
		qU.uRH = mkHalfQuadrant(ui.ora, true, m.bE.reso, m.goodForm);
			qU.uRH =rotate(rotate( qU.uRH, m.bE.reso), m.bE.reso);
		qU.uRV = mkHalfQuadrant(ui.blu, false,m.bE.reso, m.badForm);
			qU.uRV =flipDiagonal( qU.uRV, m.bE.reso-1);
			offsetLeftwards( qU.uRV, m.bE.reso-1); offsetUpwards( qU.uRV, m.bE.reso);
		qU.dLH = mkHalfQuadrant(ui.lil, true, m.bE.reso, m.goodForm);
		qU.dLV = mkHalfQuadrant(ui.gre, false,m.bE.reso, m.badForm);
			qU.dLV =flipDiagonal(rotate(rotate( qU.dLV, m.bE.reso-1), m.bE.reso-1), m.bE.reso-1);
			offsetRightwards( qU.dLV, m.bE.reso-1); offsetDownwards( qU.dLV, m.bE.reso);
		qU.dRH = mkHalfQuadrant(ui.red, true, m.bE.reso, m.goodForm);
			qU.dRH =flipDiagonal(rotate(rotate(rotate( qU.dRH, m.bE.reso), m.bE.reso), m.bE.reso), m.bE.reso);
		qU.dRV = mkHalfQuadrant(ui.cya, false,m.bE.reso, m.badForm);
			qU.dRV =rotate(rotate(rotate( qU.dRV, m.bE.reso-1),m.bE.reso-1),m.bE.reso-1);
			offsetLeftwards( qU.dRV, m.bE.reso-1); offsetDownwards( qU.dRV, m.bE.reso);

		qU.uL = connectHalfQuadrants( qU.uLV, qU.uLH, m.bE.reso);
		qU.uR = connectHalfQuadrants( qU.uRV, qU.uRH, m.bE.reso);
		qU.dL = connectHalfQuadrants( qU.dLV, qU.dLH, m.bE.reso);
		qU.dR = connectHalfQuadrants( qU.dRV, qU.dRH, m.bE.reso);

		qU.u = mkXYColumn( ui.gra.h, m.bE.reso);
		qU.d = mkXYColumn( ui.gra.h, m.bE.reso);
		qU.l = mkXYRow( ui.gra.l, m.bE.reso);
		qU.r = mkXYRow( ui.gra.l, m.bE.reso);
		qU.c =[{ h: ui.gra.f.h, s: ui.gra.f.s, v: ui.gra.f.v}];

		qU.U = interleaveQuadrants( m.bE.reso, qU.uL, 	qU.u, 	qU.uR);
		qU.C = [qU.l.concat( qU.c).concat(qU.r)]; 					
		qU.D = interleaveQuadrants( m.bE.reso, qU.dL, 	qU.d, 	qU.dR);

		qU = qU.U.concat( qU.C).concat( qU.D);
		}
	m.qU = qU}
function parseModalForm(m){ var h=""; var v="";
	if(!m.bE.male){
		m.goodForm.forEach( function(s){ h=h+s});
		m.badForm.forEach(  function(s){ v=v+s});
		switch( h){ case 'abc': m.gMF = "α, β, γ"; 			m.gAriQ = "Y"; 			m.gAriK = "X - Y"; 		break;
					case 'acb': m.gMF = "α, γ, β"; 			m.gAriQ = "X - Y"; 		m.gAriK = "Y"; 			break;
					case 'bac': m.gMF = "β, α, γ";			m.gAriQ = "Y"; 			m.gAriK = "R - X";		break;
					case 'bca': m.gMF = "β, γ, α";			m.gAriQ = "X - Y"; 		m.gAriK = "R - X";		break;
					case 'cab': m.gMF = "γ, α, β";			m.gAriQ = "R - X"; 		m.gAriK = "Y";			break;
					case 'cba': m.gMF = "γ, β, α";			m.gAriQ = "R - X"; 		m.gAriK = "X - Y";		}
		switch( v){ case 'abc': m.bMF = "α', β', γ'";		m.bAriQ = "-X"; 		m.bAriK = "X - Y";		break;
					case 'acb': m.bMF = "α', γ', β'";		m.bAriQ = "X - Y"; 		m.bAriK = "-X";			break;
					case 'bac': m.bMF = "β', α', γ'";		m.bAriQ = "-X"; 		m.bAriK = "Y - R";		break;
					case 'bca': m.bMF = "β', γ', α'";		m.bAriQ = "X - Y"; 		m.bAriK = "Y - R";		break;
					case 'cab': m.bMF = "γ', α', β'";		m.bAriQ = "Y - R"; 		m.bAriK = "-X";			break;
					case 'cba': m.bMF = "γ', β', α'";		m.bAriQ = "Y - R"; 		m.bAriK = "X - Y";		}}
	else{
		m.badForm.forEach(  function(s){ h=h+s});
		m.goodForm.forEach( function(s){ v=v+s});
		switch( v){ case 'abc': m.gMF = "α, β, γ"; 			m.gAriQ = "X"; 			m.gAriK = "Y - X"; 		break;
					case 'acb': m.gMF = "α, γ, β"; 			m.gAriQ = "Y - X"; 		m.gAriK = "X"; 			break;
					case 'bac': m.gMF = "β, α, γ";			m.gAriQ = "X"; 			m.gAriK = "R - Y";		break;
					case 'bca': m.gMF = "β, γ, α";			m.gAriQ = "Y - X"; 		m.gAriK = "R - Y";		break;
					case 'cab': m.gMF = "γ, α, β";			m.gAriQ = "R - Y"; 		m.gAriK = "X";			break;
					case 'cba': m.gMF = "γ, β, α";			m.gAriQ = "R - Y"; 		m.gAriK = "Y - X";		}
		switch( h){ case 'abc': m.bMF = "α', β', γ'";		m.bAriQ = "-Y"; 		m.bAriK = "Y - X";		break;
					case 'acb': m.bMF = "α', γ', β'";		m.bAriQ = "Y - X"; 		m.bAriK = "-Y";			break;
					case 'bac': m.bMF = "β', α', γ'";		m.bAriQ = "-Y"; 		m.bAriK = "X - R";		break;
					case 'bca': m.bMF = "β', γ', α'";		m.bAriQ = "Y - X"; 		m.bAriK = "X - R";		break;
					case 'cab': m.bMF = "γ', α', β'";		m.bAriQ = "X - R"; 		m.bAriK = "-Y";			break;
					case 'cba': m.bMF = "γ', β', α'";		m.bAriQ = "X - R"; 		m.bAriK = "Y - X";		}}
	if(h==v){ m.symm=true} else{ m.symm=false}}
function modalFlip(mf,f){ var ret=[];
	mf.forEach( function(mf){ ret.push(mf)});
	switch(f) { case 1: ret[0]=mf[1]; ret[1]=mf[0]; break;
				case 2: ret[1]=mf[2]; ret[2]=mf[1]; break;
				case 3: ret[0]=mf[2]; ret[2]=mf[0]} return(ret)}
function getModalFormByPrimalMood(m){
	//console.log(m);
	if(!m.pM.head){ m.goodForm =modalFlip(m.goodForm,2)}
	for(let n=0; n < m.pM.tail.length; n++){
		switch(m.pM.tail[n]){  	case "-": 	m.badForm =modalFlip(m.badForm,1); break;
								case "+": 	m.badForm =modalFlip(m.badForm,2); break;
								case "x": 	m.badForm =modalFlip(m.badForm,1);
								 			m.badForm =modalFlip(m.badForm,2);
								 			m.badForm =modalFlip(m.badForm,1)}}}

function combineMoodAndBeing(pM,bE){
	var mO = pM.ni.substr(0, pM.ni.indexOf('B'));
	mO = mO + "_" + bE.ni + "_";
	mO = mO + pM.ni.split("B").pop();
	mO = mkMood(mO, OM.ab);
	return mO}
function mkMood2(mo){
	var primalMood= mo.ni.substr(0, mo.ni.indexOf('_'));
	var being= mo.ni.split('_')[1]; 					
	var tail= mo.ni.split("_").pop(); 					
	primalMood = primalMood+"B"+tail;
	mo.bE = mkBeing(being, OM.ab);
	mo.pM = mkPrimalMood(primalMood, OM.ab);
	getModalFormByBeing(mo, mo.bE.ni);
	getModalFormByPrimalMood(mo);
	parseModalForm(mo);
	mkXYPlane(mo);
	mapXYPlane(mo.qU, mo.bE.reso);
	evalXYPlane(mo)}
OM.AL.Moods={ seed : [
	"_MAS_","_MAS_n","_MAS_p","_MAS_np","_MAS_pn","_MAS_b","n_MAS_","n_MAS_n","n_MAS_p","n_MAS_np","n_MAS_pn","n_MAS_b",
	"_mas_","_mas_n","_mas_p","_mas_np","_mas_pn","_mas_b","n_mas_","n_mas_n","n_mas_p","n_mas_np","n_mas_pn","n_mas_b",
	"_fem_","_fem_n","_fem_p","_fem_np","_fem_pn","_fem_b","n_fem_","n_fem_n","n_fem_p","n_fem_np","n_fem_pn","n_fem_b",
	"_FEM_","_FEM_n","_FEM_p","_FEM_np","_FEM_pn","_FEM_b","n_FEM_","n_FEM_n","n_FEM_p","n_FEM_np","n_FEM_pn","n_FEM_b"],
	_MAS_:function(ni){ this.ni=ni; mkMood2(this); 		this.nI="Peaceful Man"}, 	
	_MAS_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring Man"}, 
	_MAS_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playful Man"},
	_MAS_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playfully Caring Man"}, 
	_MAS_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caringly Playful Man"},
	_MAS_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring & Playful Man"},
	n_MAS_:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Hostile Man"},
	n_MAS_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping Man"}, 
	n_MAS_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fighting Man"} ,
	n_MAS_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fightingly Escaping Man"} ,
	n_MAS_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escapingly Fighting Man"} ,
	n_MAS_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping & Fighting Man"} ,
	_mas_:function(ni){ this.ni=ni; mkMood2(this); 		this.nI="Peaceful Boy"} 	,
	_mas_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring Boy"} ,
	_mas_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playful Boy"} ,
	_mas_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playfully Caring Boy"} ,
	_mas_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caringly Playful Boy"} ,
	_mas_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring & Playful Boy"} ,
	n_mas_:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Hostile Boy"} ,
	n_mas_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping Boy"} ,
	n_mas_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fighting Boy"} ,
	n_mas_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fightingly Escaping Boy"} ,
	n_mas_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escapingly Fighting Boy"} ,
	n_mas_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping & Fighting Boy"} ,
	_FEM_:function(ni){ this.ni=ni; mkMood2(this); 		this.nI="Peaceful Woman"} 	,
	_FEM_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring Woman"} ,
	_FEM_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playful Woman"} ,
	_FEM_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playfully Caring Woman"} ,
	_FEM_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caringly Playful Woman"} ,
	_FEM_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring & Playful Woman"} ,
	n_FEM_:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Hostile Woman"} ,
	n_FEM_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping Woman"} ,
	n_FEM_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fighting Woman"} ,
	n_FEM_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fightingly Escaping Woman"} ,
	n_FEM_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escapingly Fighting Woman"} ,
	n_FEM_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping & Fighting Woman"} ,
	_fem_:function(ni){ this.ni=ni; mkMood2(this); 		this.nI="Peaceful Girl"} 	,
	_fem_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring Girl"} ,
	_fem_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playful Girl"} ,
	_fem_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Playfully Caring Girl"} ,
	_fem_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caringly Playful Girl"} ,
	_fem_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Caring & Playful Girl"} ,
	n_fem_:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Hostile Girl"} ,
	n_fem_n:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping Girl"} ,
	n_fem_p:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fighting Girl"} ,
	n_fem_np:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Fightingly Escaping Girl"} ,
	n_fem_pn:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escapingly Fighting Girl"} ,
	n_fem_b:function(ni){ this.ni=ni; mkMood2(this); 	this.nI="Escaping & Fighting Girl"}}
function inheritMood(mo,parent){if(parent){mo.parent=parent.mOs.find(o => o.ni === mo.ni)} return mo}
function mkMood( ni,parent){ var mo=null; switch(ni){
	case "_MAS_" : 		mo= new OM.AL.Moods._MAS_(ni); 		mo =inheritMood( mo,parent); return mo;
	case "_MAS_n" : 	mo= new OM.AL.Moods._MAS_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_MAS_p" : 	mo= new OM.AL.Moods._MAS_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_MAS_np" : 	mo= new OM.AL.Moods._MAS_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_MAS_pn" : 	mo= new OM.AL.Moods._MAS_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_MAS_b" : 	mo= new OM.AL.Moods._MAS_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_" : 	mo= new OM.AL.Moods.n_MAS_(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_n" : 	mo= new OM.AL.Moods.n_MAS_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_p" : 	mo= new OM.AL.Moods.n_MAS_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_np" : 	mo= new OM.AL.Moods.n_MAS_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_pn" : 	mo= new OM.AL.Moods.n_MAS_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_MAS_b" : 	mo= new OM.AL.Moods.n_MAS_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_mas_" : 		mo= new OM.AL.Moods._mas_(ni); 		mo =inheritMood( mo,parent); return mo;
	case "_mas_n" : 	mo= new OM.AL.Moods._mas_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_mas_p" : 	mo= new OM.AL.Moods._mas_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_mas_np" : 	mo= new OM.AL.Moods._mas_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_mas_pn" : 	mo= new OM.AL.Moods._mas_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_mas_b" : 	mo= new OM.AL.Moods._mas_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_" : 	mo= new OM.AL.Moods.n_mas_(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_n" : 	mo= new OM.AL.Moods.n_mas_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_p" : 	mo= new OM.AL.Moods.n_mas_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_np" : 	mo= new OM.AL.Moods.n_mas_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_pn" : 	mo= new OM.AL.Moods.n_mas_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_mas_b" : 	mo= new OM.AL.Moods.n_mas_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_FEM_" : 		mo= new OM.AL.Moods._FEM_(ni); 		mo =inheritMood( mo,parent); return mo;
	case "_FEM_n" : 	mo= new OM.AL.Moods._FEM_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_FEM_p" : 	mo= new OM.AL.Moods._FEM_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_FEM_np" : 	mo= new OM.AL.Moods._FEM_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_FEM_pn" : 	mo= new OM.AL.Moods._FEM_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_FEM_b" : 	mo= new OM.AL.Moods._FEM_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_" : 	mo= new OM.AL.Moods.n_FEM_(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_n" : 	mo= new OM.AL.Moods.n_FEM_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_p" : 	mo= new OM.AL.Moods.n_FEM_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_np" : 	mo= new OM.AL.Moods.n_FEM_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_pn" : 	mo= new OM.AL.Moods.n_FEM_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_FEM_b" : 	mo= new OM.AL.Moods.n_FEM_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_fem_" : 		mo= new OM.AL.Moods._fem_(ni); 		mo =inheritMood( mo,parent); return mo;
	case "_fem_n" : 	mo= new OM.AL.Moods._fem_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_fem_p" : 	mo= new OM.AL.Moods._fem_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_fem_np" : 	mo= new OM.AL.Moods._fem_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_fem_pn" : 	mo= new OM.AL.Moods._fem_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "_fem_b" : 	mo= new OM.AL.Moods._fem_b(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_" : 	mo= new OM.AL.Moods.n_fem_(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_n" : 	mo= new OM.AL.Moods.n_fem_n(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_p" : 	mo= new OM.AL.Moods.n_fem_p(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_np" : 	mo= new OM.AL.Moods.n_fem_np(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_pn" : 	mo= new OM.AL.Moods.n_fem_pn(ni); 	mo =inheritMood( mo,parent); return mo;
	case "n_fem_b" : 	mo= new OM.AL.Moods.n_fem_b(ni); 	mo =inheritMood( mo,parent); return mo}}
function precalcMoods(seed,parent){ var mos=[]; var mo=null;
	for(let n=0; n<48; n++){ mo=mkMood(seed[n],parent); mos.push(mo);} return mos}

OM.AL.PrimalMoods={ seed : ["B","Bn","Bp","Bnp","Bpn","Bb","nB","nBn","nBp","nBnp","nBpn","nBb"],
	B:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=[];		this.niH=""; this.niB="⚲"; this.niT=""},
	Bn:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=["-"];	this.niH=""; this.niB="⚲"; this.niT="−"},
	Bp:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=["+"];	this.niH=""; this.niB="⚲"; this.niT="+"},
	Bnp:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=["-","+"];this.niH=""; this.niB="⚲"; this.niT="−+"},
	Bpn:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=["+","-"];this.niH=""; this.niB="⚲"; this.niT="+−"},
	Bb:function( ni){ this.ni=ni; 	this.head=true; 	this.tail=["x"];	this.niH=""; this.niB="⚲"; this.niT="±"},
	nB:function( ni){ this.ni=ni; 	this.head=false; 	this.tail=[];		this.niH="−";this.niB="⚲"; this.niT=""},
	nBn:function( ni){ this.ni=ni; 	this.head=false; 	this.tail=["-"];	this.niH="−";this.niB="⚲"; this.niT="−"},
	nBp:function( ni){ this.ni=ni; 	this.head=false; 	this.tail=["+"];	this.niH="−";this.niB="⚲"; this.niT="+"},
	nBnp:function( ni){ this.ni=ni; this.head=false; 	this.tail=["-","+"];this.niH="−";this.niB="⚲"; this.niT="−+"},
	nBpn:function( ni){ this.ni=ni; this.head=false; 	this.tail=["+","-"];this.niH="−";this.niB="⚲"; this.niT="+−"},
	nBb:function( ni){ this.ni=ni; 	this.head=false; 	this.tail=["x"];	this.niH="−";this.niB="⚲"; this.niT="±"}}
function inheritPrimalMood(pm,parent){if(parent){pm.parent=parent.pMs.find(o => o.ni === pm.ni)} return pm}
function mkPrimalMood( ni,parent){ var pm=null; switch(ni){
	case "B" 	: pm= new OM.AL.PrimalMoods.B( ni);    pm =inheritPrimalMood( pm,parent); return pm;
	case "Bn" 	: pm= new OM.AL.PrimalMoods.Bn( ni);   pm =inheritPrimalMood( pm,parent); return pm;
	case "Bp" 	: pm= new OM.AL.PrimalMoods.Bp( ni);   pm =inheritPrimalMood( pm,parent); return pm;
	case "Bnp" 	: pm= new OM.AL.PrimalMoods.Bnp( ni);  pm =inheritPrimalMood( pm,parent); return pm;
	case "Bpn" 	: pm= new OM.AL.PrimalMoods.Bpn( ni);  pm =inheritPrimalMood( pm,parent); return pm;
	case "Bb" 	: pm= new OM.AL.PrimalMoods.Bb( ni);   pm =inheritPrimalMood( pm,parent); return pm;
	case "nB" 	: pm= new OM.AL.PrimalMoods.nB( ni);   pm =inheritPrimalMood( pm,parent); return pm;
	case "nBn" 	: pm= new OM.AL.PrimalMoods.nBn( ni);  pm =inheritPrimalMood( pm,parent); return pm;
	case "nBp" 	: pm= new OM.AL.PrimalMoods.nBp( ni);  pm =inheritPrimalMood( pm,parent); return pm;
	case "nBnp" : pm= new OM.AL.PrimalMoods.nBnp( ni); pm =inheritPrimalMood( pm,parent); return pm;
	case "nBpn" : pm= new OM.AL.PrimalMoods.nBpn( ni); pm =inheritPrimalMood( pm,parent); return pm;
	case "nBb" 	: pm= new OM.AL.PrimalMoods.nBb( ni);  pm =inheritPrimalMood( pm,parent); return pm}}
function precalcPrimalMoods(seed,parent){ var pms=[]; var pm=null;
	for(let n=0; n<12; n++){ pm=mkPrimalMood( seed[n],parent); pms.push(pm);} return pms}

OM.AL.Beings={ seed:["FEM","fem","MAS","mas"],
	MAS:function( ni){ this.ni=ni; this.adult=true; this.male=true;  this.reso=4; this.nI="♂"; 	},
	mas:function( ni){ this.ni=ni; this.adult=false;this.male=true;  this.reso=4; this.nI="*♂"; },
	fem:function( ni){ this.ni=ni; this.adult=false;this.male=false; this.reso=4; this.nI="*♀"; },
	FEM:function( ni){ this.ni=ni; this.adult=true; this.male=false; this.reso=4; this.nI="♀"; 	}}
function getModalFormByBeing(m,ni){  switch(ni){ 
	case "MAS": m.goodForm = ['a','b','c']; m.badForm =['a','c','b']; break;
	case "mas": m.goodForm = ['a','b','c']; m.badForm =['c','a','b']; break;
	case "fem": m.goodForm = ['b','a','c']; m.badForm =['a','c','b']; break;
	case "FEM": m.goodForm = ['c','b','a']; m.badForm =['a','c','b']}  return m}
function inheritBeing(be,parent){if(parent){be.parent=parent.bEs.find(o => o.ni === be.ni)} return be}
function mkBeing( ni,parent){ var be=null; switch(ni){
	case "MAS": be= new OM.AL.Beings.MAS( ni); be =inheritBeing( be,parent); return be;
	case "mas": be= new OM.AL.Beings.mas( ni); be =inheritBeing( be,parent); return be;
	case "fem": be= new OM.AL.Beings.fem( ni); be =inheritBeing( be,parent); return be;
	case "FEM": be= new OM.AL.Beings.FEM( ni); be =inheritBeing( be,parent); return be}}
function precalcBeings(seed,parent){ var bes =[]; var bu=null;
	for(let n=0; n < 4;n++){ bu=mkBeing( seed[n],parent); bes.push(bu);} return bes;}

OM.AL.Sociotypes={ seed:["ISFC","ISFR","ISTC","ISTR","INFC","INFR","INTC","INTR","ESFC","ESFR","ESTC","ESTR","ENFC","ENFR","ENTC","ENTR","NaT"],
	ISFC:function( ni){ this.ni=ni; this.ie=false;this.sn=false;this.ft=false;this.cr=false;this.zo="Wolverine"},
	ISFR:function( ni){ this.ni=ni; this.ie=false;this.sn=false;this.ft=false;this.cr=true; this.zo="Dolphin"},
	ISTC:function( ni){ this.ni=ni; this.ie=false;this.sn=false;this.ft=true; this.cr=false;this.zo="Alligator"},
	ISTR:function( ni){ this.ni=ni; this.ie=false;this.sn=false;this.ft=true; this.cr=true; this.zo="Anaconda"},
	INFC:function( ni){ this.ni=ni; this.ie=false;this.sn=true; this.ft=false;this.cr=false;this.zo="Platypus"},
	INFR:function( ni){ this.ni=ni; this.ie=false;this.sn=true; this.ft=false;this.cr=true; this.zo="Octopus"},
	INTC:function( ni){ this.ni=ni; this.ie=false;this.sn=true; this.ft=true; this.cr=false;this.zo="Panda"},
	INTR:function( ni){ this.ni=ni; this.ie=false;this.sn=true; this.ft=true; this.cr=true; this.zo="Raven"},
	ESFC:function( ni){ this.ni=ni; this.ie=true; this.sn=false;this.ft=false;this.cr=false;this.zo="Zebra"},
	ESFR:function( ni){ this.ni=ni; this.ie=true; this.sn=false;this.ft=false;this.cr=true; this.zo="Turtle"},
	ESTC:function( ni){ this.ni=ni; this.ie=true; this.sn=false;this.ft=true; this.cr=false;this.zo="Hippo"},
	ESTR:function( ni){ this.ni=ni; this.ie=true; this.sn=false;this.ft=true; this.cr=true; this.zo="Jaguar"},
	ENFC:function( ni){ this.ni=ni; this.ie=true; this.sn=true; this.ft=false;this.cr=false;this.zo="Nightingale"},
	ENFR:function( ni){ this.ni=ni; this.ie=true; this.sn=true; this.ft=false;this.cr=true; this.zo="Swan"},
	ENTC:function( ni){ this.ni=ni; this.ie=true; this.sn=true; this.ft=true; this.cr=false;this.zo="Piranha"},
	ENTR:function( ni){ this.ni=ni; this.ie=true; this.sn=true; this.ft=true; this.cr=true; this.zo="Falcon"},
	NaT: function( ni){ this.ni=ni; }}
function connectSpaces(abs,rel){	rel[0][0][0].IE = abs[0][0][0];	rel[0][0][2].IE = abs[0][0][2];
	rel[0][2][0].IE = abs[0][2][0];	rel[0][2][2].IE = abs[0][2][2];	rel[2][0][0].IE = abs[2][0][0];
	rel[2][0][2].IE = abs[2][0][2];	rel[2][2][0].IE = abs[2][2][0];	rel[2][2][2].IE = abs[2][2][2]; return rel}
function tor(src){ var ret = mk3Space();
	ret[0][2][0]=src[0][0][0];	ret[2][2][0]=src[0][2][0];	ret[2][0][0]=src[2][2][0];	ret[0][0][0]=src[2][0][0];
	ret[0][2][2]=src[0][0][2];	ret[2][2][2]=src[0][2][2];	ret[2][0][2]=src[2][2][2];	ret[0][0][2]=src[2][0][2];

	ret[1][2][2]=src[0][1][2];	ret[2][1][2]=src[1][2][2];	ret[1][0][2]=src[2][1][2];	ret[0][1][2]=src[1][0][2];

	ret[2][0][1]=src[0][0][1];	ret[2][2][1]=src[2][0][1];	ret[0][2][1]=src[2][2][1];	ret[0][0][1]=src[0][2][1];

	ret[1][2][0]=src[0][1][0];	ret[2][1][0]=src[1][2][0];	ret[1][0][0]=src[2][1][0];	ret[0][1][0]=src[1][0][0];
	return ret}
function rot(src){ var ret = mk3Space();
	ret[0][0][0]=src[0][2][0];	ret[0][2][0]=src[2][2][0];	ret[2][2][0]=src[2][0][0];	ret[2][0][0]=src[0][0][0];
	ret[0][0][2]=src[0][2][2];	ret[0][2][2]=src[2][2][2];	ret[2][2][2]=src[2][0][2];	ret[2][0][2]=src[0][0][2];

	ret[0][1][2]=src[1][2][2];	ret[1][2][2]=src[2][1][2];	ret[2][1][2]=src[1][0][2];	ret[1][0][2]=src[0][1][2];

	ret[0][0][1]=src[2][0][1];	ret[2][0][1]=src[2][2][1];	ret[2][2][1]=src[0][2][1];	ret[0][2][1]=src[0][0][1];

	ret[0][1][0]=src[1][2][0];	ret[1][2][0]=src[2][1][0];	ret[2][1][0]=src[1][0][0];	ret[1][0][0]=src[0][1][0];
  	return ret}
function ver(src){ var ret = mk3Space(); for(var z=0; z<3; z++){ for(var y=0; y<3; y++){ for(var x=0; x<3; x++){
	ret[z][2-y][x] = src[z][y][x];}}}  return ret}
function lon(src){ var ret = mk3Space(); for(var z=0; z<3; z++){ for(var y=0; y<3; y++){ for(var x=0; x<3; x++){
	ret[2-z][y][x] = src[z][y][x];}}}  return ret}
function lat(src){ var ret = mk3Space(); for(var z=0; z<3; z++){ for(var y=0; y<3; y++){ for(var x=0; x<3; x++){
	ret[z][y][2-x] = src[z][y][x];}}}  return ret}

function orientRelSpace(ty, relSpace){ switch(ty.ni){
	case "ISTR": relSpace =connectSpaces(ty.absSpace, tor(lon(lat(relSpace)))); break; // !!
	case "ISTC": relSpace =connectSpaces(ty.absSpace, tor(lat(relSpace))); break; // !!
	case "ESTR": relSpace =connectSpaces(ty.absSpace, tor(lon(relSpace))); break; // !!
	case "ESTC": relSpace =connectSpaces(ty.absSpace, tor(relSpace)); break; // !!
	case "INFR": relSpace =connectSpaces(ty.absSpace, rot(lon(lat(relSpace)))); break; // !!
	case "INFC": relSpace =connectSpaces(ty.absSpace, rot(lat(relSpace))); break; // !!
	case "ENFR": relSpace =connectSpaces(ty.absSpace, rot(lon(relSpace))); break; // rot lon!!!!
	case "ENFC": relSpace =connectSpaces(ty.absSpace, rot(relSpace)); break;
	case "ISFR": relSpace =connectSpaces(ty.absSpace, lon(lat(ver(relSpace)))); break;
	case "ISFC": relSpace =connectSpaces(ty.absSpace, lat(ver(relSpace))); break;
	case "ESFR": relSpace =connectSpaces(ty.absSpace, lon(ver(relSpace))); break;
	case "ESFC": relSpace =connectSpaces(ty.absSpace, ver(relSpace)); break;
	case "INTC": relSpace =connectSpaces(ty.absSpace, lon(lat(relSpace))); break;
	case "INTR": relSpace =connectSpaces(ty.absSpace, lat(relSpace)); break;
	case "ENTC": relSpace =connectSpaces(ty.absSpace, lon(relSpace)); break;
	case "ENTR": relSpace =connectSpaces(ty.absSpace, relSpace); }  return relSpace;
}
// replace inherit functions with one
function mkSociotype2( ty){ ty.IEs = precalcInformationElements(OM.AL.IEs.seed, OM.ab);
							ty.funcs = precalcFuncs(OM.AL.Funcs.seed, OM.ab);
							ty.circuits = precalcCircuits(OM.AL.Circuits.seed, OM.ab);
							ty.absSpace = precalcSocionicsMetaphysics( ty.IEs);
							ty.relSpace = orientRelSpace(ty, precalcSocionicsEssence( ty.funcs, ty.circuits));
							ty.circuits = orientCirc2(ty);
							return ty}
function inheritSociotype(ty,parent){if(parent){ty.parent=parent.tYs.find(o => o.ni === ty.ni)} return ty}
function mkSociotype(ni,parent){ var ty =null; switch( ni){
	case "ISFC":ty=new OM.AL.Sociotypes.ISFC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ISFR":ty=new OM.AL.Sociotypes.ISFR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ISTC":ty=new OM.AL.Sociotypes.ISTC(ni); ty=inheritSociotype(ty,parent); return ty; 
	case "ISTR":ty=new OM.AL.Sociotypes.ISTR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "INFC":ty=new OM.AL.Sociotypes.INFC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "INFR":ty=new OM.AL.Sociotypes.INFR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "INTC":ty=new OM.AL.Sociotypes.INTC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "INTR":ty=new OM.AL.Sociotypes.INTR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ESFC":ty=new OM.AL.Sociotypes.ESFC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ESFR":ty=new OM.AL.Sociotypes.ESFR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ESTC":ty=new OM.AL.Sociotypes.ESTC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ESTR":ty=new OM.AL.Sociotypes.ESTR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ENFC":ty=new OM.AL.Sociotypes.ENFC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ENFR":ty=new OM.AL.Sociotypes.ENFR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ENTC":ty=new OM.AL.Sociotypes.ENTC(ni); ty=inheritSociotype(ty,parent); return ty;
	case "ENTR":ty=new OM.AL.Sociotypes.ENTR(ni); ty=inheritSociotype(ty,parent); return ty;
	case "NaT" :ty=new OM.AL.Sociotypes.NaT( ni); return ty;}}
function precalcSociotypes(seed){ var tys =[]; var bu=null;
	for(let n=0; n < 16;n++){ bu=precalcSociotype(seed[n]); tys.push(bu);} return tys;}
function precalcSociotype(ni,parent){
	var bu = mkSociotype2(mkSociotype( ni, parent)); return bu;}

function orientCirc2(ty){ var C=null;
	if(ty.ie){ C = ty.circuits.filter(o => o.lat); C.forEach( function(C){ C.aDi = C.rDi});}
	else 	 { C = ty.circuits.filter(o => o.lat); C.forEach( function(C){ C.aDi = -C.rDi});}
		if(ty.sn){
			C = ty.circuits.filter(o => o.ver); C.forEach( function(C){ C.aDi = C.rDi});
			if(ty.cr){ C = ty.circuits.filter(o => o.lon); C.forEach( function(C){ C.aDi = -C.rDi})}
			else {C = ty.circuits.filter(o => o.lon); C.forEach( function(C){ C.aDi = C.rDi})}}
		else{
			C = ty.circuits.filter(o => o.ver); C.forEach( function(C){ C.aDi = -C.rDi});
			if(ty.cr){ C = ty.circuits.filter(o => o.lon); C.forEach( function(C){ C.aDi = C.rDi})}
			else {C = ty.circuits.filter(o => o.lon); C.forEach( function(C){ C.aDi = -C.rDi})}}}
function orientCirc(space,x,y,z,circ){
	if 		(circ.lat)	{ circ.acc = space[x][y][z-circ.rDi]; circ.pro = space[x][y][z+circ.rDi]}
	else if (circ.lon)	{ circ.acc = space[x-circ.rDi][y][z]; circ.pro = space[x+circ.rDi][y][z]}
	else 				{ circ.acc = space[x][y-circ.rDi][z]; circ.pro = space[x][y+circ.rDi][z]}
	return circ}
function precalcSocionicsEssence(funcs, circs){ var space =mk3Space();
	space[2][0][2] = funcs.find(o => o.ni == "f1");	
	space[2][0][0] = funcs.find(o => o.ni == "f2");	
	space[0][0][0] = funcs.find(o => o.ni == "f3");	
	space[0][0][2] = funcs.find(o => o.ni == "f4");	
	space[0][2][2] = funcs.find(o => o.ni == "f5");	
	space[0][2][0] = funcs.find(o => o.ni == "f6");	
	space[2][2][0] = funcs.find(o => o.ni == "f7");	
	space[2][2][2] = funcs.find(o => o.ni == "f8");
	space[2][0][1] = orientCirc(space,2,0,1,circs.find(o => o.ni == "a"));
	space[1][0][0] = orientCirc(space,1,0,0,circs.find(o => o.ni == "g"));
	space[0][0][1] = orientCirc(space,0,0,1,circs.find(o => o.ni == "b"));
	space[0][1][2] = orientCirc(space,0,1,2,circs.find(o => o.ni == "i"));
	space[0][2][1] = orientCirc(space,0,2,1,circs.find(o => o.ni == "c"));
	space[1][2][0] = orientCirc(space,1,2,0,circs.find(o => o.ni == "h"));
	space[2][2][1] = orientCirc(space,2,2,1,circs.find(o => o.ni == "d"));
	space[1][2][2] = orientCirc(space,1,2,2,circs.find(o => o.ni == "e"));
	space[1][0][2] = orientCirc(space,1,0,2,circs.find(o => o.ni == "f"));
	space[2][1][0] = orientCirc(space,2,1,0,circs.find(o => o.ni == "k"));
	space[2][1][2] = orientCirc(space,2,1,2,circs.find(o => o.ni == "l"));
	space[0][1][0] = orientCirc(space,0,1,0,circs.find(o => o.ni == "j")); return space}

OM.AL.Circuits={ seed:["a","b","c","d","e","f","g","h","i","j","k","l"],
	a:function( ni){ this.lon=false;this.lat=true; this.ver=false;this.rDi=-1;this.ni=ni;this.str=1;},
	b:function( ni){ this.lon=false;this.lat=true; this.ver=false;this.rDi=-1;this.ni=ni;this.str=1;},
	c:function( ni){ this.lon=false;this.lat=true; this.ver=false;this.rDi=-1;this.ni=ni;this.str=1;},
	d:function( ni){ this.lon=false;this.lat=true; this.ver=false;this.rDi=-1;this.ni=ni;this.str=1;},
	e:function( ni){ this.lon=true; this.lat=false;this.ver=false;this.rDi=1; this.ni=ni;this.str=2;},
	f:function( ni){ this.lon=true; this.lat=false;this.ver=false;this.rDi=-1;this.ni=ni;this.str=0;},
	g:function( ni){ this.lon=true; this.lat=false;this.ver=false;this.rDi=-1;this.ni=ni;this.str=0;},
	h:function( ni){ this.lon=true; this.lat=false;this.ver=false;this.rDi=1; this.ni=ni;this.str=2;},
	i:function( ni){ this.lon=false;this.lat=false;this.ver=true; this.rDi=1; this.ni=ni;this.str=1;},
	j:function( ni){ this.lon=false;this.lat=false;this.ver=true; this.rDi=-1;this.ni=ni;this.str=1;},
	k:function( ni){ this.lon=false;this.lat=false;this.ver=true; this.rDi=-1;this.ni=ni;this.str=1;},
	l:function( ni){ this.lon=false;this.lat=false;this.ver=true; this.rDi=1; this.ni=ni;this.str=1;}}
function inheritCirc(circ,parent){ if(parent){ circ.parent = parent.relSpace.find(o => o.ni === circ.ni)} return circ}
function mkCircuit(ni,parent){var circ=null; switch( ni){
	case "a":circ=new OM.AL.Circuits.a( ni); circ=inheritCirc(circ,parent); return circ;
	case "b":circ=new OM.AL.Circuits.b( ni); circ=inheritCirc(circ,parent); return circ;
	case "c":circ=new OM.AL.Circuits.c( ni); circ=inheritCirc(circ,parent); return circ;
	case "d":circ=new OM.AL.Circuits.d( ni); circ=inheritCirc(circ,parent); return circ;
	case "e":circ=new OM.AL.Circuits.e( ni); circ=inheritCirc(circ,parent); return circ;
	case "f":circ=new OM.AL.Circuits.f( ni); circ=inheritCirc(circ,parent); return circ;
	case "g":circ=new OM.AL.Circuits.g( ni); circ=inheritCirc(circ,parent); return circ;
	case "h":circ=new OM.AL.Circuits.h( ni); circ=inheritCirc(circ,parent); return circ;
	case "i":circ=new OM.AL.Circuits.i( ni); circ=inheritCirc(circ,parent); return circ;
	case "j":circ=new OM.AL.Circuits.j( ni); circ=inheritCirc(circ,parent); return circ;
	case "k":circ=new OM.AL.Circuits.k( ni); circ=inheritCirc(circ,parent); return circ;
	case "l":circ=new OM.AL.Circuits.l( ni); circ=inheritCirc(circ,parent); return circ}}
function precalcCircuits(seed,parent){ circs =[]; var bu=null;
	for(let n=0; n < 12;n++){ bu=mkCircuit( seed[n],parent); circs.push(bu);} return circs;}

OM.AL.Funcs={ seed: ["f1","f2","f3","f4","f5","f6","f7","f8"],
	f1:function( ni){ this.lon=true; this.lat=true; this.ver=false;this.ni=ni;this.in="1",this.str=false;},
	f2:function( ni){ this.lon=true; this.lat=false;this.ver=false;this.ni=ni;this.in="2",this.str=false;},
	f3:function( ni){ this.lon=false;this.lat=false;this.ver=false;this.ni=ni;this.in="3",this.str=false;},
	f4:function( ni){ this.lon=false;this.lat=true; this.ver=false;this.ni=ni;this.in="4",this.str=false;},
	f5:function( ni){ this.lon=false;this.lat=true; this.ver=true; this.ni=ni;this.in="5",this.str=true;},
	f6:function( ni){ this.lon=false;this.lat=false;this.ver=true; this.ni=ni;this.in="6",this.str=true;},
	f7:function( ni){ this.lon=true; this.lat=false;this.ver=true; this.ni=ni;this.in="7",this.str=true;},
	f8:function( ni){ this.lon=true; this.lat=true; this.ver=true; this.ni=ni;this.in="8",this.str=true;}}
function inheritFunc(func,parent){ if(parent){ func.parent = parent.funcs.find(o => o.ni === func.ni)} return func}
function mkFunc(ni,parent){ var func=null; switch( ni){
	case "f1":func=new OM.AL.Funcs.f1( ni); func=inheritFunc(func,parent); return func;
	case "f2":func=new OM.AL.Funcs.f2( ni); func=inheritFunc(func,parent); return func;
	case "f3":func=new OM.AL.Funcs.f3( ni); func=inheritFunc(func,parent); return func;
	case "f4":func=new OM.AL.Funcs.f4( ni); func=inheritFunc(func,parent); return func;
	case "f5":func=new OM.AL.Funcs.f5( ni); func=inheritFunc(func,parent); return func;
	case "f6":func=new OM.AL.Funcs.f6( ni); func=inheritFunc(func,parent); return func;
	case "f7":func=new OM.AL.Funcs.f7( ni); func=inheritFunc(func,parent); return func;
	case "f8":func=new OM.AL.Funcs.f8( ni); func=inheritFunc(func,parent); return func}}
function precalcFuncs(seed,parent){ funcs =[]; var bu=null;
	for(let n=0; n < 8;n++){ bu=mkFunc( seed[n],parent); funcs.push(bu);} return funcs;}

function precalcSocionicsMetaphysics(IEs){ var space =mk3Space();
	space[0][0][0] = IEs.find(o => o.ni === "Fi");	space[0][0][2] = IEs.find(o => o.ni === "Fe");
	space[2][0][0] = IEs.find(o => o.ni === "Si");	space[2][0][2] = IEs.find(o => o.ni === "Se");
	space[0][2][0] = IEs.find(o => o.ni === "Ni");	space[0][2][2] = IEs.find(o => o.ni === "Ne");
	space[2][2][0] = IEs.find(o => o.ni === "Ti");	space[2][2][2] = IEs.find(o => o.ni === "Te"); return space}
OM.AL.IEs={ seed: ["Fi","Fe","Si","Se","Ti","Te","Ni","Ne"],
	Fi:function( ni){ this.mo=false; this.ud=false; this.ie=false; this.ni=ni},
	Fe:function( ni){ this.mo=false; this.ud=false; this.ie= true; this.ni=ni},
	Si:function( ni){ this.mo= true; this.ud=false; this.ie=false; this.ni=ni},
	Se:function( ni){ this.mo= true; this.ud=false; this.ie= true; this.ni=ni},
	Ti:function( ni){ this.mo= true; this.ud= true; this.ie=false; this.ni=ni},
	Te:function( ni){ this.mo= true; this.ud= true; this.ie= true; this.ni=ni},
	Ni:function( ni){ this.mo=false; this.ud= true; this.ie=false; this.ni=ni},
	Ne:function( ni){ this.mo=false; this.ud= true; this.ie= true; this.ni=ni}}
function inheritIE(IE,parent){ if(parent){ IE.parent = parent.IEs.find(o => o.ni === IE.ni)} return IE}
function mkIE(ni,parent){ var IE =null; switch( ni){
	case "Fi":IE=new OM.AL.IEs.Fi(ni); IE=inheritIE(IE,parent); return IE;
	case "Fe":IE=new OM.AL.IEs.Fe(ni); IE=inheritIE(IE,parent); return IE;
	case "Si":IE=new OM.AL.IEs.Si(ni); IE=inheritIE(IE,parent); return IE;
	case "Se":IE=new OM.AL.IEs.Se(ni); IE=inheritIE(IE,parent); return IE;
	case "Ti":IE=new OM.AL.IEs.Ti(ni); IE=inheritIE(IE,parent); return IE;
	case "Te":IE=new OM.AL.IEs.Te(ni); IE=inheritIE(IE,parent); return IE;
	case "Ni":IE=new OM.AL.IEs.Ni(ni); IE=inheritIE(IE,parent); return IE;
	case "Ne":IE=new OM.AL.IEs.Ne(ni); IE=inheritIE(IE,parent); return IE}}
function precalcInformationElements(seed,parent){ IEs =[]; var bu=null;
	for(let n=0; n < 8;n++){ bu=mkIE( seed[n],parent); IEs.push(bu);} return IEs;}

function mk3Space(){ var space=[]; for(var z=0; z<=2;z++){space[z]=[];
										for(var y=0; y<=2; y++){space[z][y]=[];
											for(var x=0; x<=2; x++){space[z][y][x]=null}}} return space}

function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}


function initTurn(sim){
	sim.personInTurn.mCppl = mkNullMatrix( 4*sim.personInTurn.mo.bE.reso+2);
	for(var n=0; n<sim.personInTurn.ppl.length; n++){ populateMosaic(sim.personInTurn, sim.personInTurn.ppl[n])}}
function attemptMove( mX, mY, preview){
	if(AL.personInTurn.mo.bE.male&&mX<2*AL.personInTurn.mo.bE.reso+1&&mY<2*AL.personInTurn.mo.bE.reso+1) {
		var mvX= mX -AL.personInTurn.mo.bE.reso;
		var mvY= mY -AL.personInTurn.mo.bE.reso;
		if( preview){ previewMove( AL.sim, mX, mY, mvX, mvY);return false}
		else 		{ movePeople ( AL.sim, mX, mY, mvX, mvY);return true }}
	else if(!AL.personInTurn.mo.bE.male&& mX<2*AL.personInTurn.mo.bE.reso+1&&mY>2*AL.personInTurn.mo.bE.reso){
		var mvX=mX -AL.personInTurn.mo.bE.reso;
		var mvY=mY -((AL.personInTurn.mo.bE.reso*3)+1);
		if( preview){ previewMove( AL.sim, mX, mY, mvX, mvY);return false}
		else 		{ movePeople ( AL.sim, mX, mY, mvX, mvY);return true }}
	return false}
function previewMove( sim, mX, mY, mvX, mvY){
	/*sim.personInTurn.mCpreview = sim.personInTurn.mCppl;*/
}
function movePeople ( sim, mX, mY, mvX, mvY){
	sim.personInTurn.ppl.forEach(function(p){
		if(p.ni.in == sim.personInTurn.ni.in){ p.mo.mX =mX; p.mo.mY =mY}
		else{
			p.mo.mX+=mvX; while( p.mo.mX < 0){ p.mo.mX += 4*AL.personInTurn.mo.bE.reso+2}
			while( p.mo.mX>= 4*AL.personInTurn.mo.bE.reso+2){ p.mo.mX -= 4*AL.personInTurn.mo.bE.reso+2}
			p.mo.mY+=mvY; while( p.mo.mY < 0){ p.mo.mY += 4*AL.personInTurn.mo.bE.reso+2}
			while( p.mo.mY >= 4*AL.personInTurn.mo.bE.reso+2){ p.mo.mY -= 4*AL.personInTurn.mo.bE.reso+2}}});
	sim.people.forEach(function(p){
		if(p.ni.in == sim.personInTurn.ni.in){ p.mo.mX =mX; p.mo.mY =mY}
		else{
			p.mo.mX+=mvX; while( p.mo.mX < 0){ p.mo.mX += 4*AL.personInTurn.mo.bE.reso+2}
			while( p.mo.mX>= 4*AL.personInTurn.mo.bE.reso+2){ p.mo.mX -= 4*AL.personInTurn.mo.bE.reso+2}
			p.mo.mY+=mvY; while( p.mo.mY < 0){ p.mo.mY += 4*AL.personInTurn.mo.bE.reso+2}
			while( p.mo.mY >= 4*AL.personInTurn.mo.bE.reso+2){ p.mo.mY -= 4*AL.personInTurn.mo.bE.reso+2}}});
	//var vX= mvX; 	var vY= -mvY;
	initTurn( AL.sim);
	clearScreen();
	draw();}

function populateMosaic(person,other){
	//console.log(person);
	if(!Array.isArray(person.mCppl[ other.mo.mY][other.mo.mX])) { person.mCppl[ other.mo.mY][other.mo.mX]=[]}
	person.mCppl[ other.mo.mY][other.mo.mX].push(other)}
function processSubTurn(sim,ev){
	if(sim.subTurn<sim.people.length-1){
		sim.subTurn++;
		sim.personInTurn =sim.people[sim.subTurn]}
	else{
		sim.subTurn=0;
		sim.turn++;
		sim.personInTurn =sim.people[sim.subTurn]}
	console.log(sim.personInTurn);
	AL.personInTurn = sim.personInTurn;
	precalcOthers( AL.sim.people);

	console.log(AL.personInTurn);
	initTurn( AL.sim);
	clearScreen();
	draw();}
	
function orderPeople(sim){
	var first=[]; var second=[];
	sim.people.forEach( function(p){ if(p.mo.symm){ first.push( p)} else{ second.push( p)}});
	first =shuffle(first);
	second=shuffle(second);
	first=first.concat(second);
	sim.personInTurn =first[sim.subTurn];
	return first}
function Simulation(ppl){
	this.people=ppl; this.events=[]; this.turn=0; this.subTurn=0;
	orderPeople(this); OM.re.sims.push(this); this.in=OM.re.sims.length-1;}
function precalcSims(ppl){
	OM.re.sims =[];
	var buf = new Simulation(ppl)}

function precalc() {	OM.ab.IEs 		=precalcInformationElements( OM.AL.IEs.seed);
						OM.ab.absSpace 	=precalcSocionicsMetaphysics( OM.ab.IEs);
						OM.ab.funcs 	=precalcFuncs( OM.AL.Funcs.seed); 
						OM.ab.circuits 	=precalcCircuits( OM.AL.Circuits.seed); 
						OM.ab.relSpace 	=precalcSocionicsEssence( OM.ab.funcs, OM.ab.circuits);
						//OM.ab.tY 		=precalcSocionicsArchetype()
						OM.ab.tYs 		=precalcSociotypes( OM.AL.Sociotypes.seed);

						OM.ab.bEs 		=precalcBeings( OM.AL.Beings.seed);
						OM.ab.pMs 		=precalcPrimalMoods( OM.AL.PrimalMoods.seed);
						OM.ab.mOs 		=precalcMoods( OM.AL.Moods.seed);
						
						precalcPeople();
						AL.pE = OM.re.people[0];
						AL.tY = OM.re.people[0].ty;
						AL.mO = OM.re.people[0].mo;
						AL.bE = OM.re.people[0].mo.bE;
						AL.pM = OM.re.people[0].mo.pM;
						AL.mC = OM.re.people[0].mo.mC;

						precalcSims( OM.re.people);
						AL.sim 			=OM.re.sims[0];
						AL.personInTurn =OM.re.sims[0].personInTurn;

						precalcOthers( OM.re.sims[0].people);
						initTurn( AL.sim);

						console.log(OM);

						}

precalc();
</script></head><body>
	<div id="sBdiv"></div>
	<div id="bBdiv"></div>
	<script>(function() { predraw(); draw();})();</script>
	<script type="text/javascript">var sc_project=863932;var sc_invisible=1;var sc_security="0ed0c038";</script>
	<script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async></script>
	<noscript><div class="statcounter"><a title="Web Analytics Made Easy - StatCounter" href="http://statcounter.com/" target="_blank"><img class="statcounter" src="//c.statcounter.com/863932/0/0ed0c038/1/" alt="Web Analytics Made Easy - StatCounter"></a></div></noscript>


</body></html>
